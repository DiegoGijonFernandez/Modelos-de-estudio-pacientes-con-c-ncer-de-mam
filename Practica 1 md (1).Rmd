---
title: "Pr√°ctica 1 - Miner√≠a de Datos"
author: "Diego Gij√≥n Fern√°ndez, Ingenier√≠a Bionform√°tica - UMA"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
lang: es
output: 
  html_document:
    toc: true
    toc_depth: 4
    self_contained: true
    theme: cosmo
    highlight: tango
    code_folding: hide
    df_print: paged
    number_sections: true
    fig_caption: true
    includes:
      in_header: estilos_personalizados.html
  

---

<!-- Logo fuera del chunk R -->
<img src="logo_universidad.png" alt="Logo Universidad" style="height: 120px;">
  
PRIMERAMENTE MENCIONAR QUE HE USADO CHAGTP PARA LA MEJORA DE ESCRITURA Y C√ìDIGO DE ESTE TRABAJO

# Introducci√≥n
El objetivo principal de este trabajo es identificar el mejor modelo multivariante capaz de predecir de forma eficaz la respuesta patol√≥gica completa (RCP) en pacientes con c√°ncer de mama, a partir de distintas variables cl√≠nicas. Aunque algunas variables puedan mostrar asociaci√≥n individual con la RCP, no necesariamente implican una contribuci√≥n significativa cuando se consideran conjuntamente en un modelo. Por ello, se utilizar√° un enfoque de regresi√≥n paso a paso (stepwise regression), que permite seleccionar de forma autom√°tica el conjunto √≥ptimo de variables, optimizando criterios como el AIC para alcanzar un modelo que explique mejor los datos, evitando el uso de fuerza bruta.

En el contexto cl√≠nico actual, el tratamiento del c√°ncer de mama ha evolucionado hacia una estrategia cada vez m√°s personalizada, teniendo en cuenta las caracter√≠sticas tanto del tumor como del paciente. Entre los factores emergentes con posible influencia en la respuesta terap√©utica destaca la microbiota intestinal, cuya alteraci√≥n ‚Äîpor ejemplo, mediante el uso de antibi√≥ticos‚Äî puede afectar la funci√≥n del sistema inmune y, en consecuencia, la eficacia de los tratamientos oncol√≥gicos.

El tratamiento neoadyuvante, consistente en administrar quimioterapia antes de la cirug√≠a, permite evaluar directamente la respuesta del tumor. El objetivo cl√≠nico m√°s favorable es alcanzar una respuesta patol√≥gica completa, que se asocia con mejores tasas de supervivencia a largo plazo. No obstante, el uso de antibi√≥ticos durante este proceso podr√≠a modificar la microbiota intestinal, generando un estado de disbiosis que compromete la inmunomodulaci√≥n y potencialmente reduce la efectividad terap√©utica.

Aunque este fen√≥meno ya ha sido descrito en c√°nceres como el de pulm√≥n, ri√±√≥n o melanoma, su impacto espec√≠fico en c√°ncer de mama sigue sin estar bien definido. Por ello, el presente estudio se plantea como una oportunidad para analizar en profundidad si el uso de antibi√≥ticos durante o antes del tratamiento neoadyuvante influye negativamente en los resultados cl√≠nicos en pacientes con c√°ncer de mama.

# Hip√≥tesis y Objetivos
La hip√≥tesis central plantea que el uso de antibi√≥ticos en pacientes con c√°ncer de mama, durante o en las semanas previas al inicio del tratamiento neoadyuvante, podr√≠a comprometer la efectividad del mismo. Esto se debe a la posible alteraci√≥n de la microbiota intestinal, que juega un papel clave en la modulaci√≥n inmune, el microambiente tumoral y la metabolizaci√≥n de f√°rmacos.

El objetivo del estudio es evaluar si las pacientes que reciben antibi√≥ticos presentan:

-Menores tasas de respuesta completa patol√≥gica (medida a trav√©s de la escala RCB).

-Peores resultados de supervivencia global.

-Mayor probabilidad de reca√≠da posterior al tratamiento.

Para ello, se aplicar√°n t√©cnicas estad√≠sticas descriptivas, pruebas de asociaci√≥n y modelos multivariantes que permitan identificar los factores m√°s influyentes.

# Fuentes de Datos (Poblaci√≥n de Estudio)
Los datos utilizados en este estudio provienen de la Unidad de Gesti√≥n Cl√≠nica de Oncolog√≠a M√©dica del Hospital Regional de M√°laga, los cuales est√°n almacenados en el sistema de informaci√≥n cl√≠nica Gal√©n. Esta base de datos oncol√≥gica contiene una gran cantidad de informaci√≥n estructurada y no estructurada relacionada con los pacientes oncol√≥gicos atendidos en la unidad, incluyendo aspectos cl√≠nicos, tratamientos recibidos, resultados quir√∫rgicos, participaci√≥n en ensayos cl√≠nicos, datos gen√©ticos y seguimiento.

La poblaci√≥n de estudio est√° compuesta por pacientes diagnosticadas de c√°ncer de mama entre los a√±os 2009 y 2023, que fueron tratadas con quimioterapia neoadyuvante y posteriormente sometidas a cirug√≠a.

```{r setup}
# Vamos a centrar todas las figuras y a dejarlas a un tama√±o m√°s c√≥modo
knitr::opts_chunk$set(fig.align='center', fig.width=6, fig.height=4, out.width='70%')
```


Antes de comenzar con el an√°lisis, procedemos a la importaci√≥n del conjunto de datos cl√≠nicos desde un archivo Excel, que contiene informaci√≥n relevante sobre pacientes con c√°ncer de mama tratadas con quimioterapia neoadyuvante.
```{r  vista_tabla, warning=FALSE, message=FALSE, results='asis'}
# Cargar librer√≠as necesarias
library(readxl)
library(dplyr)
library(kableExtra)
library(caret)
library(nnet)
library(pROC)

# Definir la ruta del archivo (ajustar si es necesario)
ruta <- "C:/Users/diego/Downloads/muestra_700_UGC.xlsx"

# Lectura del archivo Excel
datos <- read_excel(ruta)



datos %>%
  head(10) %>%
  kable("html", caption = "Vista preliminar de las primeras observaciones del conjunto de datos cl√≠nicos") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = TRUE,
                position = "center") %>%
  scroll_box(width = "100%", height = "400px")

```


Antes de nada, estudiamos las variables:
```{r warning=FALSE, message=FALSE}

str(datos) # Da la descripci√≥n de la estructura de datos


```

Podemos observar que este dataset contiene 28 variables relacionadas con el diagnostico , tratamient y evoluci√≥n de los pacientes. Las variables clave incluyen datos demogr√°ficos como el sexo, la edad al diagn√≥stico y el estado menop√°usico, as√≠ como informaci√≥n sobre el tratamiento recibido, incluyendo el tipo de cirug√≠a, la quimioterapia neoadyuvante y la terapia hormonal. Tambi√©n se consideran caracter√≠sticas del tumor, como el tipo histol√≥gico, la localizaci√≥n, el tama√±o y la respuesta patol√≥gica (RCB). Adem√°s, se analizan los resultados cl√≠nicos, como la presencia de reca√≠das y el estado del paciente en el √∫ltimo control, junto con factores relevantes como retrasos en el tratamiento y el uso de antibi√≥ticos, incluyendo la cantidad administrada. La √∫ltima variable tiene en el nombre un salto de l√≠nea. Corregiremos esto m√°s adelante.

## Preprocesamiento

A continuaci√≥n, se lleva a cabo un an√°lisis estad√≠stico descriptivo sobre las variables num√©ricas presentes en el conjunto de datos. Este an√°lisis incluye:

- Medidas de tendencia central: media y mediana, que indican la localizaci√≥n del centro de los datos.

- Medidas de dispersi√≥n: rango, rango intercuart√≠lico (RIC), desviaci√≥n t√≠pica y varianza, que ofrecen una idea del grado de variabilidad entre los valores observados.




```{r estadisticas}
# Librer√≠as para an√°lisis y visualizaci√≥n
library(tidyr)
library(ggplot2)
library(purrr)

# Filtramos solo las variables num√©ricas
datos_numericos <- datos %>% select(where(is.numeric))

# Calculamos estad√≠sticas resumen para cada variable num√©rica
estadisticas <- map_dfr(
  datos_numericos,
  ~ tibble(
    M√≠nimo = min(., na.rm = TRUE),
    M√°ximo = max(., na.rm = TRUE),
    Media = mean(., na.rm = TRUE),
    Mediana = median(., na.rm = TRUE),
    Cuartil_1 = quantile(., 0.25, na.rm = TRUE),
    Cuartil_3 = quantile(., 0.75, na.rm = TRUE),
    RIC = IQR(., na.rm = TRUE),
    Desviaci√≥n_T√≠pica = sd(., na.rm = TRUE),
    Varianza = var(., na.rm = TRUE)
  ),
  .id = "Variable"
)

# Formato largo para graficar
estadisticas_largo <- estadisticas %>%
  pivot_longer(-Variable, names_to = "Estad√≠stica", values_to = "Valor")

# Gr√°fico comparativo de estad√≠sticas
ggplot(estadisticas_largo, aes(x = Variable, y = Valor, fill = Estad√≠stica)) +
  geom_col(position = "dodge") +
  coord_flip() +
  labs(title = "Estad√≠sticas descriptivas por variable num√©rica",
       x = "Variable", y = "Valor") +
  theme_minimal()


```
El gr√°fico de estad√≠sticas descriptivas muestra una alta varianza en los valores de los receptores hormonales (`RE` y `RP`) y del √≠ndice de proliferaci√≥n (`Ki67`), lo que indica una gran dispersi√≥n en estos marcadores entre los pacientes, reflejando la heterogeneidad biol√≥gica de los tumores. En contraste, variables como la edad al diagn√≥stico (`EDAD_DIAGNOSTICO`), el tama√±o tumoral (`TAMA√ëO`), el n√∫mero de antibi√≥ticos y el grado histol√≥gico (`GRADO`) presentan menor varianza, lo que sugiere mayor homogeneidad entre los casos. Este patr√≥n es consistente con lo que se espera en estudios cl√≠nicos: los marcadores moleculares tienden a variar m√°s entre pacientes, mientras que caracter√≠sticas demogr√°ficas como la edad o algunas medidas cl√≠nicas son m√°s estables. La visualizaci√≥n tambi√©n muestra que, en general, la media y la mediana de cada variable est√°n pr√≥ximas, lo que sugiere distribuciones relativamente sim√©tricas para muchas de ellas, aunque las diferencias observadas en variables como `RE` y `Ki67` podr√≠an indicar asimetr√≠a o presencia de valores extremos.

## An√°lisis exploratorio b√°sico de los datos.

La funci√≥n summary proporciona resumenes de las distribuciones de las variables de los datos:

```{r warning=FALSE, message=FALSE}
summary(datos)
```

El conjunto de datos cl√≠nicos est√° compuesto por 700 observaciones correspondientes a pacientes con c√°ncer de mama, e incluye tanto variables num√©ricas como categ√≥ricas. La edad al diagn√≥stico (`EDAD_DIAGNOSTICO`) presenta una media de aproximadamente 52 a√±os, con un rango entre 26 y 79, lo cual es consistente con la distribuci√≥n esperada en poblaci√≥n oncol√≥gica femenina. El tama√±o tumoral (`TAMA√ëO`) var√≠a entre 0.6 y 12 cm, con una media de 3.8 cm, lo que refleja una alta heterogeneidad en la presentaci√≥n del tumor. Las variables hormonales (`RE`, `RP`, `HER2`) y el √≠ndice de proliferaci√≥n celular (`Ki67`) tambi√©n muestran una gran dispersi√≥n, destacando la variabilidad biol√≥gica entre pacientes; en particular, `Ki67` tiene una media cercana al 44% y algunos valores faltantes. La mayor√≠a de las variables categ√≥ricas, como `SEXO`, `ESTADO_MENOPAUSICO`, `FENOTIPO_IHQ` y `TIPO_QT_NEOADY_OK`, est√°n almacenadas como caracteres, al igual que las fechas, que deber√≠an ser transformadas al formato `Date` para an√°lisis posteriores (como el de supervivencia). Adem√°s, variables como `No_ANTIBIOTICOS` tienen una distribuci√≥n asim√©trica con un valor m√°ximo de 5, indicando que algunas pacientes recibieron m√∫ltiples tandas de antibi√≥ticos. Esta primera exploraci√≥n sugiere que el conjunto de datos es adecuado para un an√°lisis cl√≠nico multivariable, aunque requerir√° limpieza y transformaci√≥n previa.

# An√°lisis univariante

## Transformaci√≥n de Variables Categ√≥ricas y Preparaci√≥n de Datos

Al revisar el contenido y la naturaleza de las variables, se ha considerado adecuado transformar ciertas columnas en factores, dado que representan **categor√≠as cl√≠nicas sin relaci√≥n num√©rica inherente**. Espec√≠ficamente, las variables **`Tn`** (clasificaci√≥n del tama√±o tumoral) y **`Nx`** (afectaci√≥n ganglionar) codifican niveles ordinales cl√≠nicos sin una progresi√≥n lineal clara, por lo que deben tratarse como variables categ√≥ricas para evitar interpretaciones err√≥neas en los modelos estad√≠sticos.

```{r, warning=FALSE, message=FALSE}
# Convertir Tn y Nx a factores
datos$Tn <- as.factor(datos$Tn)
datos$Nx <- as.factor(datos$Nx)

```

Del mismo modo, la variable **`ESTADIO`**, que indica el estadio cl√≠nico del tumor, se representa mediante niveles como "I", "IIA", "IIIB", etc. Tratar esta variable como num√©rica inducir√≠a a modelos a asumir una relaci√≥n lineal entre los estadios, lo cual no tiene justificaci√≥n cl√≠nica. Al convertirla en un factor, se mejora tanto la interpretaci√≥n estad√≠stica como la visualizaci√≥n en gr√°ficos y tablas.

```{r}
# Convertir ESTADIO en variable categ√≥rica
datos$ESTADIO <- as.factor(datos$ESTADIO)

# Exploraci√≥n inicial
summary(datos$ESTADIO)

# Visualizaci√≥n de la distribuci√≥n
barplot(table(datos$ESTADIO), main = "Distribuci√≥n de Estadios", col = "steelblue")
pie(table(datos$ESTADIO), main = "Proporci√≥n por Estadio", cex = 1.2)
```

El gr√°fico de barras evidencia que los estadios IIA y IIB son los m√°s frecuentes, concentrando la mayor parte de los casos, con m√°s de 200 pacientes cada uno. Esto sugiere que una proporci√≥n significativa de pacientes fue diagnosticada en etapas intermedias de la enfermedad, lo cual es com√∫n en contextos donde el diagn√≥stico precoz a√∫n no es sistem√°tico.

Por otro lado, los estadios I, IA, IB y IIIC presentan una frecuencia considerablemente menor, indicando que tanto los diagn√≥sticos muy precoces como los m√°s avanzados son menos comunes en esta muestra. Los estadios IIIA y IIIB tambi√©n tienen una representaci√≥n notable, aunque menor que los II intermedios.

La gr√°fica de pastel complementa esta visualizaci√≥n al mostrar la proporci√≥n relativa de cada estadio. Se observa nuevamente que IIA e IIB abarcan juntos la mayor parte de la poblaci√≥n, seguidos por IIIA y IIIB. Esto aporta una visi√≥n clara de la heterogeneidad cl√≠nica del grupo estudiado y sugiere que el an√°lisis posterior de respuesta al tratamiento y pron√≥stico debe contemplar esta variabilidad en la clasificaci√≥n cl√≠nica inicial.

Otras variables como **`HISTOLOGIA`** tambi√©n deben considerarse categ√≥ricas, ya que definen tipos espec√≠ficos de tejido tumoral sin un orden impl√≠cito. 

```{r}
# Convertir HISTOLOGIA en factor
datos$HISTOLOGIA <- as.factor(datos$HISTOLOGIA)
```

En cuanto a las variables num√©ricas, por ejemplo, `TAMA√ëO`, se puede calcular la desviaci√≥n est√°ndar como medida de dispersi√≥n para detectar variabilidad entre casos:

```{r}
# Desviaci√≥n est√°ndar del tama√±o tumoral
sd(datos$TAMA√ëO, na.rm = TRUE)
```



Las variables num√©ricas en un conjunto de datos cl√≠nicos pueden clasificarse en dos tipos:  
- **Discretas**, que toman valores enteros (como la edad o el n√∫mero de antibi√≥ticos).  
- **Continuas**, que admiten cualquier valor real dentro de un rango (como el tama√±o tumoral en cent√≠metros).

Esta distinci√≥n es relevante, especialmente al aplicar pruebas estad√≠sticas en an√°lisis de asociaci√≥n, ya que algunos m√©todos requieren conocer si los valores pueden repetirse o si existen **empates (ties)** en la distribuci√≥n de datos.

A continuaci√≥n, se realiza un resumen estad√≠stico b√°sico para la variable `EDAD_DIAGNOSTICO`, que representa la edad del paciente al momento del diagn√≥stico.

```{r, warning=FALSE, message=FALSE}
# C√°lculo de estad√≠sticas b√°sicas
mean(datos$EDAD_DIAGNOSTICO, na.rm = TRUE)   # Media
var(datos$EDAD_DIAGNOSTICO, na.rm = TRUE)    # Varianza
sd(datos$EDAD_DIAGNOSTICO, na.rm = TRUE)     # Desviaci√≥n est√°ndar
median(datos$EDAD_DIAGNOSTICO, na.rm = TRUE) # Mediana

# Resumen completo con summary()
summary(datos$EDAD_DIAGNOSTICO)
```



El rango de edad en la muestra va desde los 26 hasta los 99 a√±os, con una mediana de 52 a√±os y una media algo distorsionada (156.3), lo que sugiere la posible presencia de un valor at√≠pico o error de codificaci√≥n. Este tipo de valores extremos tambi√©n influyen fuertemente en la varianza y la desviaci√≥n est√°ndar, por lo que se recomienda realizar una limpieza de valores an√≥malos antes del an√°lisis definitivo.


La representaci√≥n gr√°fica de variables num√©ricas permite identificar patrones de distribuci√≥n, valores extremos, simetr√≠a o asimetr√≠a, y otros comportamientos importantes. A continuaci√≥n, se presentan tres tipos de gr√°ficos:



```{r}
hist(datos$EDAD_DIAGNOSTICO,
     main = "Distribuci√≥n de la Edad al Diagn√≥stico",
     xlab = "Edad",
     ylab = "Frecuencia",
     col = "steelblue",
     border = "white")
```
Se observa una distribuci√≥n aproximadamente sim√©trica, centrada en torno a los 50 a√±os, que tambi√©n coincide con la mediana calculada anteriormente. La mayor√≠a de los pacientes se encuentra en el rango de 45 a 65 a√±os, con un pico de frecuencia entre los 45 y 50 a√±os, lo cual es coherente con la edad habitual de diagn√≥stico del c√°ncer de mama en mujeres.

Se nota adem√°s una disminuci√≥n progresiva en la frecuencia tanto hacia los extremos inferiores (<40 a√±os) como superiores (>70 a√±os), lo que sugiere que los casos en edades muy j√≥venes o muy avanzadas son menos comunes en esta muestra. No se aprecian grandes sesgos ni bimodalidad, lo que indica una distribuci√≥n bastante regular. 


```{r}
boxplot(datos$EDAD_DIAGNOSTICO, 
        main = "Boxplot vertical de Edad al Diagn√≥stico", 
        ylab = "Edad",
        col = "lightgray")

boxplot(datos$EDAD_DIAGNOSTICO, 
        horizontal = TRUE, 
        main = "Boxplot horizontal de Edad al Diagn√≥stico", 
        xlab = "Edad",
        col = "lightgray")
```
Los datos est√°n comprendidos entre aproximadamente 28 y 79 a√±os, con una mediana cercana a los 52 a√±os, lo que concuerda con los estad√≠sticos descriptivos previos. El rango intercuart√≠lico (entre el primer y tercer cuartil) se sit√∫a entre los 45 y 65 a√±os, indicando que la mayor√≠a de los casos se agrupan en ese intervalo.

Con el objetivo de asegurar la calidad y coherencia de los an√°lisis posteriores, se aplican una serie de pasos de limpieza al conjunto de datos original:

Se eliminan aquellas columnas sin variabilidad (es decir, con un √∫nico valor para todos los casos), ya que no aportan informaci√≥n √∫til al an√°lisis.

Se reemplazan los valores vac√≠os, representados como cadenas vac√≠as ("") o como texto "NA", por valores faltantes reales (NA) compatibles con el manejo estad√≠stico en R.

Se calcula el porcentaje de valores ausentes por variable, lo que permite identificar columnas con datos incompletos y valorar estrategias de imputaci√≥n o exclusi√≥n.

```{r}
# Eliminar columnas con un √∫nico valor
datos <- datos[, sapply(datos, function(x) length(unique(na.omit(x))) > 1)]

# Reemplazar cadenas vac√≠as o "NA" como texto por NA real
datos[] <- lapply(datos, function(x) ifelse(trimws(as.character(x)) %in% c("", "NA"), NA, x))

# Calcular el porcentaje de valores NA por variable
na_percent <- colMeans(is.na(datos)) * 100
na_percent

```
La variable Ki67 y su versi√≥n dicot√≥mica KI67_DICOT presentan un 0.43% de valores faltantes (equivalente a 3 casos), lo cual es poco preocupante y f√°cilmente imputable o descartable seg√∫n el enfoque.

Las variables Nx y ESTADIO presentan una proporci√≥n m√≠nima de 0.14% de valores ausentes (1 caso cada una), tambi√©n manejable sin comprometer el an√°lisis.

La variable HT_ADY_OK, correspondiente a si la paciente recibi√≥ hormonoterapia adyuvante, es la √∫nica con una proporci√≥n m√°s relevante: un 2.71% de datos faltantes (alrededor de 19 casos). Esta variable deber√° ser tratada con especial cuidado en an√°lisis multivariantes o de supervivencia, valorando si conviene imputar, excluir los registros afectados o crear una categor√≠a espec√≠fica ("Desconocido").

Este proceso de preprocesamiento garantiza que el an√°lisis estad√≠stico se realice sobre un conjunto de datos limpio, homog√©neo y t√©cnicamente adecuado, lo cual es esencial para obtener resultados v√°lidos y cl√≠nicamente interpretables.

El dataset muestra que la variable `HISTOLOGIA` tiene 10 categor√≠as, siendo "DUCTAL" la m√°s frecuente. La desviaci√≥n est√°ndar de `TAMA√ëO` es 1.93, indicando una dispersi√≥n moderada en los datos. Se eliminaron columnas con un solo valor √∫nico y se reemplazaron valores vac√≠os o "NA" en texto por `NA` reales. En general, el porcentaje de valores faltantes es bajo, excepto en `HT_ADY_OK` (2.71%) y en menor medida en `Ki67`, `KI67_DICOT`, `Nx` y `ESTADIO`, lo que podr√≠a requerir imputaci√≥n. El dataset est√° bastante limpio y estructurado para su an√°lisis.

Vemos que solo hay un hombre, lo eliminamos ya no nos interesa su estudio
```{r}


# Filtrar las filas donde SEXO no sea "H"
datos <- datos[as.character(datos$SEXO) != "H", ]


# Verificar el cambio
table(datos$SEXO)


```

Vamos a observar las variables n√∫mericas. Hay enteras como EDAD_DIAGNOSTICO y reales como TAMA√ëO

```{r}
summary(datos$EDAD_DIAGNOSTICO)
hist(datos$EDAD_DIAGNOSTICO, main="Edad", ylab ="Frec", xlab= "Edad")
boxplot(datos$EDAD_DIAGNOSTICO)
```

## Valores perdidos

Los datos faltantes pueden surgir por errores en la recolecci√≥n, fallos en el almacenamiento o ausencia de respuestas en estudios. Su presencia puede reducir el tama√±o de la muestra, distorsionar las distribuciones y generar sesgos en los an√°lisis.

Existen tres tipos principales de datos perdidos: MCAR (completamente aleatorios), MAR (dependen de otras variables observadas) y MNAR (dependen de su propio valor o factores no observados). Dependiendo del tipo, se pueden aplicar diferentes estrategias de manejo. Para datos MCAR, la eliminaci√≥n de filas con valores faltantes es viable, mientras que para MAR y MNAR es preferible la imputaci√≥n mediante modelos predictivos como mice, KNN o regresi√≥n m√∫ltiple.

En primer lugar, las variables num√©ricas contienen valores extremos representados por el n√∫mero 999, el cual no tiene un significado v√°lido en el contexto cl√≠nico. Estos valores deben tratarse como valores faltantes (NA) para evitar sesgos en el an√°lisis. En segundo lugar, las variables categ√≥ricas incluyen la etiqueta Desconocido para indicar datos no registrados. Dado que esta etiqueta impide un an√°lisis adecuado, tambi√©n se sustituir√° por NA.

Para garantizar la calidad del an√°lisis y evitar distorsiones en los modelos estad√≠sticos, se procede a la conversi√≥n de estos valores en NA. Esto permitir√° gestionarlos correctamente en las etapas posteriores de preprocesamiento e imputaci√≥n de datos. En R, se utiliza la funci√≥n `na_if()` de `dplyr` para reemplazar 999 en variables num√©ricas y "Desconocido" en variables categ√≥ricas.

```{r}
datos[] <- lapply(datos, function(x) {
  if (is.character(x)) {
    x <- trimws(x)  # Eliminar espacios en blanco al principio y al final
    x <- ifelse(x %in% c("", "NA", "N/A", "null", "NULL", "NaN"), NA, x)  # Reemplazar valores problem√°ticos con NA
  }
  return(x)
})
```

## Detecci√≥n de outliers

El an√°lisis de valores at√≠picos (outliers) es una etapa clave en el preprocesamiento de datos, ya que permite identificar errores de codificaci√≥n, detectar patrones cl√≠nicamente relevantes y mejorar la precisi√≥n de los modelos estad√≠sticos. La presencia de outliers puede distorsionar las medidas de tendencia central, inflar la varianza y afectar negativamente los supuestos de normalidad y homogeneidad en muchos an√°lisis inferenciales.

Existen diferentes estrategias para tratar con estos valores extremos. En algunos casos se eliminan por tratarse de errores evidentes; en otros, se analizan por separado o se transforman para mitigar su impacto. Entre los m√©todos m√°s comunes para su detecci√≥n destacan el uso del rango intercuart√≠lico (IQR), el c√°lculo de z-scores y herramientas visuales como los boxplots.

A continuaci√≥n, se utiliza un boxplot para visualizar los valores at√≠picos en la variable TAMA√ëO, que representa el tama√±o del tumor en cent√≠metros. Posteriormente, se aplicar√° el m√©todo del rango intercuart√≠lico, donde un valor se considera at√≠pico si se encuentra fuera del intervalo definido por Q1 - 1.5 √ó IQR y Q3 + 1.5 √ó IQR.

```{r}
library(ggplot2)

# Boxplot original con posibles outliers
ggplot(datos, aes(y = TAMA√ëO)) +
  geom_boxplot(fill = "lightblue", outlier.color = "red", outlier.shape = 16) +
  theme_minimal() +
  ggtitle("Detecci√≥n de outliers en el tama√±o del tumor") +
  ylab("Tama√±o (cm)")
```


Identificaci√≥n de Outliers mediante IQR
```{r}
# C√°lculo de IQR
Q1 <- quantile(datos$TAMA√ëO, 0.25, na.rm = TRUE)
Q3 <- quantile(datos$TAMA√ëO, 0.75, na.rm = TRUE)
IQR <- Q3 - Q1

# Establecer l√≠mites para detectar outliers
limite_inferior <- Q1 - 1.5 * IQR
limite_superior <- Q3 + 1.5 * IQR

# Filtrar datos dentro del rango aceptado
datos_sin_outliers <- datos %>%
  filter(TAMA√ëO >= limite_inferior & TAMA√ëO <= limite_superior)

# Mostrar el impacto del filtrado
cat("üîπ Total de registros originales: ", nrow(datos), "\n")
cat("üîπ Registros tras eliminar outliers: ", nrow(datos_sin_outliers), "\n")
cat("üîπ Registros eliminados: ", nrow(datos) - nrow(datos_sin_outliers), "\n")
```

Boxplot tras eliminaci√≥n de outliers
```{r, warning=FALSE, message=FALSE }
library(dplyr)
library(ggplot2)
library(patchwork)  # Para combinar gr√°ficos
library(purrr)


# Obtener nombres de las variables num√©ricas
variables_numericas <- datos %>%
  select(where(is.numeric)) %>%
  colnames()

# Mostrar boxplots uno a uno
for (var in variables_numericas) {
  print(
    ggplot(datos, aes(y = .data[[var]])) +
      geom_boxplot(fill = "skyblue", outlier.color = "red", outlier.shape = 16) +
      theme_minimal(base_size = 14) +
      ggtitle(paste("Boxplot de", var)) +
      ylab(var)
  )
}



```

El boxplot correspondiente a la variable No_ANTIBIOTICOS revela una distribuci√≥n fuertemente sesgada a la derecha. La mayor√≠a de las pacientes recibieron entre 0 y 2 tandas de antibi√≥ticos, mientras que algunos casos puntuales llegaron hasta 5, siendo identificados como valores at√≠picos. Aunque estos valores se alejan del patr√≥n general, es probable que reflejen situaciones cl√≠nicas reales con infecciones recurrentes o complicaciones durante el tratamiento. Por ello, m√°s que eliminarlos directamente, ser√≠a conveniente analizarlos por separado en funci√≥n del impacto que puedan tener en los resultados.

La variable TAMA√ëO muestra una mediana cercana a los 3.3 cm, con un rango intercuart√≠lico entre 2.5 y 5 cm. No obstante, se identifican m√∫ltiples outliers por encima de los 8 cm, llegando hasta los 12.5 cm. Estos casos extremos probablemente corresponden a tumores de gran volumen en etapas avanzadas del diagn√≥stico. Dado que esta variable es clave en la estratificaci√≥n del estadio cl√≠nico y en el pron√≥stico, se recomienda evaluar si estos valores extremos afectan los modelos posteriores (por ejemplo, regresi√≥n log√≠stica o supervivencia) y decidir si deben incluirse, transformarse o tratarse por separado.

En lugar de eliminar los outliers detectados en las variables TAMA√ëO y No_ANTIBIOTICOS, se opt√≥ por mantenerlos, ya que representan situaciones cl√≠nicas plausibles. En el caso del tama√±o tumoral, los valores extremos reflejan casos avanzados que pueden ser relevantes para el pron√≥stico. Por otro lado, el n√∫mero elevado de tandas de antibi√≥ticos puede indicar complicaciones cl√≠nicas o infecciones persistentes, tambi√©n relevantes para el estudio. Para mitigar su efecto en los an√°lisis estad√≠sticos, se considera el uso de transformaciones o recodificaci√≥n categ√≥rica cuando sea necesario.

## An√°lisis de normalidad de una distribuci√≥n

Comprobar la normalidad de los datos es un paso fundamental en el an√°lisis estad√≠stico, ya que muchas pruebas inferenciales y modelos cl√°sicos ‚Äîcomo la t de Student, el ANOVA o la regresi√≥n lineal‚Äî suponen que las variables involucradas siguen una distribuci√≥n normal. Si este supuesto no se cumple, es necesario valorar alternativas, como aplicar transformaciones (logar√≠tmica, ra√≠z cuadrada o Box-Cox) o recurrir a pruebas no param√©tricas, que no requieren dicha condici√≥n.

Aunque existen representaciones m√°s avanzadas como el ajuste de curvas gaussianas, en este estudio se utilizar√°n exclusivamente los m√©todos abordados en el temario, centrados en herramientas gr√°ficas y contrastes estad√≠sticos cl√°sicos.

Para analizar la normalidad de una variable, pueden emplearse tanto m√©todos gr√°ficos como pruebas estad√≠sticas formales:

-Boxplots: √∫tiles para detectar asimetr√≠as y valores extremos que sugieren desviaciones respecto a la normalidad.

-Histogramas: muestran la forma general de la distribuci√≥n, permitiendo detectar sesgos.

-Gr√°ficos Q-Q (Quantile-Quantile): comparan los cuantiles de la variable observada con los de una distribuci√≥n normal te√≥rica, y permiten detectar diferencias visuales en la dispersi√≥n.

Complementariamente, se aplican pruebas de contraste de hip√≥tesis. Todas ellas comparten la hip√≥tesis nula de normalidad: si el p-valor resultante es menor a 0.05, se rechaza dicha hip√≥tesis, concluyendo que los datos no siguen una distribuci√≥n normal. El test m√°s com√∫nmente utilizado en la literatura es el Shapiro-Wilk, especialmente adecuado para muestras peque√±as o medianas (<5000 observaciones). En el caso de muestras m√°s grandes, se pueden emplear pruebas como Kolmogorov-Smirnov o Anderson-Darling.


Se evalu√≥ la normalidad de tres variables cl√≠nicas relevantes: Ki67, EDAD_DIAGNOSTICO y TAMA√ëO, utilizando histogramas, boxplots, gr√°ficos Q-Q y la prueba de Shapiro-Wilk. Los resultados fueron los siguientes:

-Ki67: present√≥ una distribuci√≥n claramente asim√©trica hacia la derecha, con una acumulaci√≥n de valores bajos y una cola larga en los valores altos. La prueba de Shapiro-Wilk confirm√≥ la no normalidad de la variable.

-TAMA√ëO: mostr√≥ un patr√≥n similar, con muchos tumores de peque√±o tama√±o y presencia de valores extremos. El gr√°fico Q-Q evidenci√≥ desviaciones importantes en ambas colas de la distribuci√≥n.

-EDAD_DIAGNOSTICO: mostr√≥ una distribuci√≥n aproximadamente sim√©trica, con forma cercana a la normalidad, aunque la prueba estad√≠stica detect√≥ una ligera desviaci√≥n.

En conjunto, se concluye que las variables Ki67 y TAMA√ëO no cumplen con los criterios de normalidad, mientras que EDAD_DIAGNOSTICO podr√≠a tratarse como una variable normalmente distribuida con precauci√≥n. Por tanto, en el an√°lisis posterior se valorar√° el uso de transformaciones (como logaritmo natural) o el empleo de pruebas no param√©tricas para aquellas variables que no se ajusten a la normalidad.

En caso de que una variable no cumpla con los supuestos de normalidad, existen medidas estad√≠sticas robustas que pueden ser utilizadas para describir su comportamiento:

-Mediana: representa el valor central de la distribuci√≥n y es menos sensible a los valores extremos que la media.

-Cuartiles y percentiles: permiten describir la dispersi√≥n y posici√≥n de los datos sin depender de la simetr√≠a.

-Rango intercuart√≠lico (RIC): definido como la diferencia entre el tercer y el primer cuartil (Q3 ‚Äì Q1), mide la variabilidad en la zona central de la distribuci√≥n y es resistente a outliers. Se visualiza de forma clara en los boxplots.

```{r}
# Cargar librer√≠as necesarias
library(ggplot2)

# Definir las variables num√©ricas de inter√©s
variables_interes <- c("TAMA√ëO", "EDAD_DIAGNOSTICO", "Ki67")


# Filtrar solo las variables num√©ricas
variables_numericas <- variables_interes[sapply(datos[variables_interes], is.numeric)]

# An√°lisis de normalidad
for (var in variables_numericas) {
  cat("\n--- An√°lisis de la normalidad para", var, "---\n")
  
  # Histogramas y boxplots
  hist(datos[[var]], main = paste("Histograma de", var), col = "lightblue", breaks = 20)
  boxplot(datos[[var]], main = paste("Boxplot de", var), col = "lightblue")
  
  # Q-Q Plot
  qqnorm(datos[[var]], main = paste("Q-Q Plot de", var))
  qqline(datos[[var]], col = "red")
  
  # Prueba de Shapiro-Wilk
  shapiro_test <- shapiro.test(datos[[var]])
  print(shapiro_test)
  
  # Medidas alternativas si la variable no es normal
  if (shapiro_test$p.value < 0.05) {
    cat("‚ö†Ô∏è La variable", var, "NO sigue una distribuci√≥n normal.\n")
    cat("  - Mediana:", median(datos[[var]], na.rm = TRUE), "\n")
    cat("  - Rango intercuart√≠lico (RIC):", IQR(datos[[var]], na.rm = TRUE), "\n")
    cat("  - Cuartiles: Q1 =", quantile(datos[[var]], 0.25, na.rm = TRUE),
        ", Q3 =", quantile(datos[[var]], 0.75, na.rm = TRUE), "\n")
  } else {
    cat("‚úÖ La variable", var, "sigue una distribuci√≥n normal.\n")
  }
}

```

Los resultados indican que las variables **EDAD_DIAGNOSTICO** y **Ki67** no siguen una distribuci√≥n normal, seg√∫n el test de Shapiro-Wilk. La mediana de edad al diagn√≥stico es 51 a√±os, con un rango intercuart√≠lico de 16 a√±os, mientras que la mediana de Ki67 es 40, con un rango intercuart√≠lico de 42. Estos datos sugieren una variabilidad significativa en los niveles de Ki67 y la edad de las pacientes, lo cual es crucial para el an√°lisis estad√≠stico y la interpretaci√≥n de los resultados cl√≠nicos.

Es importante destacar que aunque la variable no siga una distribuci√≥n normal, s√≠ tiene sentido calcular la media y la varianza, dado que son medidas estad√≠sticas que pueden proporcionar informaci√≥n importante sobre una variable y su distribuci√≥n. De hecho, la media es un valor que representa el centro de una distribuci√≥n de datos (indicador de tendencia central, ya que refleja la ubicaci√≥n de los valores en relaci√≥n con el centro de la distribuci√≥n) y se puede calcular para cualquier conjunto de datos independientemente de su distribuci√≥n. No obstante, hay que tener en cuenta que la media puede estar sesgada por valores at√≠picos en una distribuci√≥n que no sea normal, lo que puede distorsionar su interpretaci√≥n.


Depu√©s de este an√°lisis hemos pensado: ¬ø Si en vez de poner NA, los sustitiumos por la media, si no sigue distribucion por la mediana?

```{rwarning=FALSE}
# Cargar librer√≠as necesarias
library(dplyr)

# Funci√≥n para calcular la moda
calcular_moda <- function(x) {
  ux <- unique(na.omit(x))
  ux[which.max(tabulate(match(x, ux)))]
}

# Variables num√©ricas a tratar
numeric_vars <- c("TAMA√ëO", "GRADO", "EDAD_DIAGNOSTICO")

cat("üîÑ Imputaci√≥n de valores NA basada en normalidad:\n")

for (var in numeric_vars) {
  if (var %in% names(datos)) {
    var_data <- na.omit(datos[[var]])
    
    if (length(var_data) > 3) {  # Shapiro requiere al menos 3 valores
      # Evaluar normalidad
      shapiro_test <- shapiro.test(var_data)
      p_value <- shapiro_test$p.value
      
      # Imputaci√≥n
      if (p_value > 0.05) {
        valor_insertado <- mean(var_data, na.rm = TRUE)
        metodo <- "MEDIA"
        simbolo <- "‚úÖ"
      } else {
        valor_insertado <- calcular_moda(var_data)
        metodo <- "MODA"
        simbolo <- "‚ö†Ô∏è"
      }

      datos[[var]][is.na(datos[[var]])] <- valor_insertado
      cat(simbolo, var, "‚Üí imputado con", metodo, "=", round(valor_insertado, 2), "\n")
    } else {
      cat("‚ùå", var, ": no tiene suficientes datos para evaluar normalidad\n")
    }
  }
}

# Mostrar % de NA despu√©s del reemplazo
na_percent_after <- colMeans(is.na(datos)) * 100
cat("\nüìä Porcentaje de NA tras imputaci√≥n:\n")
print(round(na_percent_after[numeric_vars], 2))

# Filtrar las filas donde SEXO no sea "H"
datos <- subset(datos, SEXO != "H")
cat("\nüßπ Filtrado aplicado: filas con SEXO ‚â† 'H'\n")

# Verificar distribuci√≥n de SEXO
cat("üìä Distribuci√≥n de SEXO despu√©s del filtrado:\n")
print(table(datos$SEXO))

# An√°lisis de distribuci√≥n de variables num√©ricas imputadas
for (var in numeric_vars) {
  if (var %in% names(datos)) {
    cat("\nüìà An√°lisis de distribuci√≥n para", var, ":\n")
    
    # Histograma
    hist(datos[[var]],
         main = paste("Distribuci√≥n de", var),
         xlab = var,
         col = "lightblue", border = "black")
    
    # Prueba de normalidad
    shapiro_test <- shapiro.test(datos[[var]])
    print(shapiro_test)
    
    if (shapiro_test$p.value < 0.05) {
      cat("‚ö†Ô∏è", var, "NO sigue una distribuci√≥n normal.\n")
      cat("  - Mediana:", median(datos[[var]], na.rm = TRUE), "\n")
      cat("  - RIC:", IQR(datos[[var]], na.rm = TRUE), "\n")
      cat("  - Cuartiles: Q1 =", quantile(datos[[var]], 0.25, na.rm = TRUE),
          ", Q3 =", quantile(datos[[var]], 0.75, na.rm = TRUE), "\n")
    } else {
      cat("‚úÖ", var, "sigue una distribuci√≥n normal.\n")
    }
  }
}

```

‚ö†Ô∏è Sustituyendo NA en TAMA√ëO con la MODA: 3 ‚ö†Ô∏è Sustituyendo NA en GRADO con la MODA: 3 ‚ö†Ô∏è Sustituyendo NA en EDAD_DIAGNOSTICO con la MODA: 50

El histograma que representa la distribuci√≥n de la variable EDAD_DIAGNOSTICO, a simple vista, la distribuci√≥n puede parecer sim√©trica, lo cual podr√≠a sugerir una normalidad. En concreto, se imputaron los valores ausentes con los valores m√°s frecuentes: 3 cm para TAMA√ëO, grado 3 para GRADO y 50 a√±os para EDAD_DIAGNOSTICO, lo que permiti√≥ reducir el porcentaje de datos faltantes al 0% en las tres variables. El an√°lisis de distribuci√≥n confirm√≥ que ninguna de las tres variables cumple con el supuesto de normalidad seg√∫n la prueba de Shapiro-Wilk (p < 0.05 en todos los casos), observ√°ndose adem√°s asimetr√≠a y curtosis en sus respectivos histogramas. Las medidas de tendencia y dispersi√≥n refuerzan esta conclusi√≥n: TAMA√ëO mostr√≥ una mediana de 3.3 cm y un rango intercuart√≠lico (RIC) de 2.5, GRADO tuvo una mediana de 3 con RIC = 1, mientras que EDAD_DIAGNOSTICO present√≥ una mediana de 51 a√±os y un RIC de 16 a√±os. Estos resultados sugieren que, en an√°lisis posteriores, ser√° necesario utilizar enfoques estad√≠sticos no param√©tricos o transformar las variables para garantizar la validez de los modelos.




## Mutaci√≥n de datos

La recodificaci√≥n de variables categ√≥ricas es una etapa clave en el preprocesamiento, especialmente en estudios cl√≠nicos. Esta pr√°ctica permite reorganizar o agrupar categor√≠as existentes con el objetivo de optimizar el an√°lisis posterior. Las principales razones para recodificar son:

Agrupaci√≥n de categor√≠as con baja frecuencia: Algunas categor√≠as poco representadas pueden generar estimaciones inestables o sesgadas. Agruparlas con otras categor√≠as cl√≠nicamente similares aumenta la potencia estad√≠stica sin perder relevancia interpretativa.

La discretizaci√≥n consiste en convertir una variable num√©rica continua en una variable categ√≥rica, agrupando sus valores en rangos o intervalos definidos. En contextos cl√≠nicos, esta pr√°ctica tiene m√∫ltiples ventajas:

-Interpretaci√≥n m√©dica m√°s clara: Valores num√©ricos pueden carecer de significado cl√≠nico aislado, pero adquieren relevancia al ser clasificados en categor√≠as cl√≠nicas estandarizadas (p. ej., ‚Äúnormal‚Äù, ‚Äúalto riesgo‚Äù, ‚Äúcr√≠tico‚Äù).

-Reducci√≥n del impacto del ruido: Agrupar valores similares reduce la sensibilidad a peque√±as variaciones causadas por errores de medici√≥n o fluctuaciones naturales.

-Estabilidad en modelos de clasificaci√≥n: Algunos algoritmos, como los √°rboles de decisi√≥n, funcionan mejor con variables discretizadas, ya que mejoran la segmentaci√≥n y reducen la complejidad del modelo.

Centrarse solo en los tipos **ductal** y **lobulillar** es una mejor opci√≥n porque tienen suficientes datos para un an√°lisis confiable (625 y 42 casos, respectivamente), mientras que las dem√°s categor√≠as tienen frecuencias muy bajas, lo que introduce ruido y dificulta obtener conclusiones significativas. Incluir datos con muy pocas observaciones puede generar sesgos y hacer que el an√°lisis no sea representativo. Al enfocarnos en estos dos tipos principales, obtenemos comparaciones m√°s robustas y evitamos problemas de desbalance en los datos.

Recodificamos los datos de la siguiente manera:

Las variables Tn y Nx son categ√≥ricas aunque las etiquetas est√©n representadas mediante n√∫meros

TAMA√ëO_CAT :
<= 2 : "Peque√±o",
o > 2 & TAMA√ëO <= 5 : "Mediano"
o > 5 : "Grande"

GRADO_CAT:
1/2: 1, 2
3: 3

HISTOLOGIA_CAT:
DUCTAL: DUCTAL
NO DUCTAL: Resto

Ki67_CAT:
<=14: Si Ki67 es menor o igual que 14
o >14: Si ki67 es mayor que 14

FENOTIPO_IHQ_CAT:
LUMINAL: LUMINAL A, LUMINAL B
HER2: LUMINAL-HER2, HER2
TRIPLE NEGATIVO: Resto

ESTADIO_CAT:
I: I, IA, IB
II: II, IIA, IIB
III: III, IIIA, IIIB, IIIC

QT_CAT:
NO antiHER2: ANTRACICLINAS, ANTRACICLINAS-TAXANOS, ANTRACICLINAS-TAXANOS-PLATINOS, TAXANOS
antiHER2: QUIMIOTERAPIA-ANTIHER2, QUIMIOTERAPIA-ANTIHER2DOBLE
INMUNO: QUIMIOTERAPIA-ANTIHER2-INMUNOTERAPIA, QUIMIOTERAPIA-INMUNOTERAPIA

No_ANTIBIOTICOS_CAT:
Una vez: 1
Dos veces o m√°s: >=2


HER2_CAT;
Hay muchos datos diferentes, recomendamos sinmplificarlo en positivo y negativo si no tine un "+"

La variable de estudio, la respuesta completa patol√≥gica RCP, se calcular√° a partir de la variable RCB (cantidad de tumor residual) de la siguiente forma:

RCP_1 (repuesta completa patol√≥gica):
SI: RCB-0, RCB-1
NO: RCB-2, RCB-3


Tambi√©n reemplazamos los valores vac√≠os ("" o "NA" como string) por NA en todo el dataset y eliminamos aquellas edades erroneas o il√≥gicas. 

```{r, warning=FALSE}
library(dplyr)
library(DT)

#  Eliminar columnas con un √∫nico valor (sin variabilidad)
datos <- datos[, sapply(datos, function(x) length(unique(x)) > 1)]

#  Reemplazar valores vac√≠os o "NA" (como texto) por NA reales
datos[] <- lapply(datos, function(x) ifelse(x == "" | x == "NA", NA, x))

# Verificar imputaci√≥n correcta de NA
colSums(is.na(datos))

#  Correcci√≥n de EDAD_DIAGNOSTICO (rango razonable: 0‚Äì120)
datos$EDAD_DIAGNOSTICO <- as.numeric(as.character(datos$EDAD_DIAGNOSTICO))
datos$EDAD_DIAGNOSTICO <- ifelse(datos$EDAD_DIAGNOSTICO < 0 | datos$EDAD_DIAGNOSTICO > 120, NA, datos$EDAD_DIAGNOSTICO)

#Recodificaci√≥n de variables y nuevas categor√≠as
datos <- datos %>%
  mutate(
    # Tn y Nx como factores categ√≥ricos (aunque sus valores sean num√©ricos)
    Tn = as.factor(Tn),
    Nx = as.factor(Nx),

    # Categorizaci√≥n de tama√±o tumoral
    TAMA√ëO_CAT = case_when(
      TAMA√ëO <= 2 ~ "Peque√±o",
      TAMA√ëO > 2 & TAMA√ëO <= 5 ~ "Mediano",
      TAMA√ëO > 5 ~ "Grande",
      TRUE ~ NA_character_
    ) %>% as.factor(),

    # Agrupaci√≥n del grado histol√≥gico
    GRADO_CAT = case_when(
      GRADO %in% c(1, 2) ~ "1/2",
      GRADO == 3 ~ "3",
      TRUE ~ as.character(GRADO)
    ) %>% as.factor(),

    # Simplificaci√≥n de histolog√≠a: ductal vs no ductal
    HISTOLOGIA = case_when(
      HISTOLOGIA == "DUCTAL" ~ "Ductal",
      TRUE ~ "No Ductal"
    ) %>% as.factor(),

    # Discretizaci√≥n de Ki67
    Ki67_CAT = case_when(
      Ki67 <= 14 ~ "<=14",
      Ki67 > 14 ~ ">14",
      TRUE ~ NA_character_
    ) %>% as.factor(),

    # Reagrupaci√≥n de fenotipo IHQ
    FENOTIPO_IHQ = case_when(
      grepl("Luminal", FENOTIPO_IHQ, ignore.case = TRUE) ~ "Luminal",
      grepl("Her2", FENOTIPO_IHQ, ignore.case = TRUE) ~ "Her2",
      TRUE ~ "Triple Negativo"
    ) %>% as.factor(),

    # Agrupaci√≥n de estadio
    ESTADIO_CAT = case_when(
      ESTADIO %in% c("I", "IA", "IB", "IC") ~ "I",
      ESTADIO %in% c("II", "IIA", "IIB") ~ "II",
      TRUE ~ "III"
    ) %>% as.factor(),

    # Categorizaci√≥n de tratamiento neoadyuvante
    QT_CAT = case_when(
      TIPO_QT_NEOADY_OK %in% c("ANTRACICLINAS", "ANTRACICLINAS-TAXANOS", "ANTRACICLINAS-TAXANOS-PLATINOS", "TAXANOS") ~ "NO antiHER2",
      TIPO_QT_NEOADY_OK %in% c("QUIMIOTERAPIA-ANTIHER2", "QUIMIOTERAPIA-ANTIHER2DOBLE", "ANTIHER2") ~ "antiHER2",
      TRUE ~ "INMUNO"
    ) %>% as.factor(),

    # Recodificaci√≥n del n√∫mero de tandas de antibi√≥ticos
    No_ANTIBIOTICOS_CAT = case_when(
      No_ANTIBIOTICOS == 1 ~ "Una vez",
      No_ANTIBIOTICOS >= 2 ~ "Dos veces o m√°s",
      No_ANTIBIOTICOS == 0 ~ NA_character_
    ) %>% as.factor(),

    # Clasificaci√≥n de HER2 como positivo/negativo
    HER2_CAT = case_when(
      grepl("\\+", HER2) ~ "Positivo",
      TRUE ~ "Negativo"
    ) %>% as.factor(),

    # Categorizaci√≥n de respuesta patol√≥gica completa
    RCP_1 = case_when(
      RCB == "RCB-0" ~ "SI",
      RCB %in% c("RCB-I", "RCB-II", "RCB-III") ~ "NO",
      TRUE ~ NA_character_
    ) %>% as.factor()
  )

# 6. Verificar estructura final
str(datos)

# 7. Visualizaci√≥n interactiva

datos %>%
  head(10) %>%
  kable("html", caption = "Vista preliminar de las primeras observaciones del conjunto de datos cl√≠nicos") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = TRUE,
                position = "center") %>%
  scroll_box(width = "100%", height = "400px")

```
El an√°lisis del conjunto de datos revela una estructura limpia y bien organizada, compuesta por 699 observaciones y 35 variables. Tras los procesos de imputaci√≥n y limpieza, la mayor√≠a de las variables clave no presentan valores faltantes, a excepci√≥n de Ki67, KI67_DICOT y HT_ADY_OK, con 3, 3 y 19 casos ausentes respectivamente, lo que representa un impacto f√°cilmente gestionable. 


```{r,warning=FALSE}
library(dplyr)

# 1. Mostrar conteo de valores NA antes de imputar
cat("üîç Valores NA antes de la imputaci√≥n:\n")
na_antes <- colSums(is.na(datos))
print(na_antes[na_antes > 0])

# 2. Imputar Ki67 con la mediana (distribuci√≥n no normal)
mediana_ki67 <- median(datos$Ki67, na.rm = TRUE)
datos$Ki67[is.na(datos$Ki67)] <- mediana_ki67

# 3. Recalcular KI67_DICOT a partir de la variable imputada y corregir clasificaci√≥n de No_ANTIBIOTICOS_CAT
datos <- datos %>%
  mutate(KI67_DICOT = case_when(
    Ki67 <= 14 ~ "<=14",
    Ki67 > 14 ~ ">14",
    TRUE ~ NA_character_
  ) %>% as.factor())

datos <- datos %>%
  mutate(No_ANTIBIOTICOS_CAT = case_when(
    No_ANTIBIOTICOS == 0 ~ "Ninguno",
    No_ANTIBIOTICOS == 1 ~ "Una vez",
    No_ANTIBIOTICOS >= 2 ~ "Dos veces o m√°s",
    TRUE ~ NA_character_
  ) %>% as.factor())

# Verificar que no hay NAs (salvo si faltan datos en No_ANTIBIOTICOS original)
cat("\nüìä Distribuci√≥n de No_ANTIBIOTICOS_CAT:\n")
print(table(datos$No_ANTIBIOTICOS_CAT, useNA = "ifany"))

# 4. Imputar HT_ADY_OK con la moda (m√°s frecuente)
moda_ht <- names(sort(table(datos$HT_ADY_OK), decreasing = TRUE))[1]
datos$HT_ADY_OK[is.na(datos$HT_ADY_OK)] <- moda_ht

# 5. Mostrar NA despu√©s de la imputaci√≥n
cat("\n‚úÖ Valores NA despu√©s de la imputaci√≥n:\n")
na_despues <- colSums(is.na(datos))
print(na_despues[na_despues > 0])

# 6. Confirmar visualmente con un resumen
cat("\nüìã Resumen final de las variables imputadas:\n")
summary(datos[, c("Ki67", "KI67_DICOT", "HT_ADY_OK")])

```
Primero, identificamos y tratamos los valores ausentes, imputando `Ki67` con la mediana debido a su distribuci√≥n asim√©trica, y regenerando `KI67_DICOT` a partir de la variable corregida. Para `HT_ADY_OK`, se aplic√≥ imputaci√≥n con la moda, dada su naturaleza categ√≥rica y su relevancia cl√≠nica. Tambi√©n transformamos las variables `Tn` y `Nx` en factores, ya que, aunque codificadas num√©ricamente, representan estadios cl√≠nicos cualitativos. En cuanto a `No_ANTIBIOTICOS_CAT`, corregimos su clasificaci√≥n al considerar expl√≠citamente el valor `0` como "Ninguno", evitando que se trate err√≥neamente como NA y permitiendo diferenciar entre pacientes que no recibieron antibi√≥ticos, los que recibieron una vez, y aquellos con m√∫ltiples tandas. 

La variable EDAD_DIAGNOSTICO se encuentra debidamente numerizada y acotada dentro de un rango cl√≠nicamente razonable. Por otro lado, variables como ESTADIO_CAT presentan una √∫nica categor√≠a registrada, lo que sugiere una falta de variabilidad que podr√≠a limitar su utilidad anal√≠tica. Finalmente, se observa que las variables recodificadas (TAMA√ëO_CAT, GRADO_CAT, HER2_CAT, Ki67_CAT, etc.) han sido correctamente generadas, y el dataset est√° en condiciones √≥ptimas para ser utilizado en an√°lisis descriptivos, modelos predictivos y pruebas de asociaci√≥n cl√≠nica.

# An√°lisis bivariante

El an√°lisis bivariante permite explorar la relaci√≥n entre dos variables, proporcionando informaci√≥n esencial sobre si una diferencia observada o una posible asociaci√≥n en los datos es estad√≠sticamente significativa o simplemente atribuible al azar. Para ello, se aplican diversas pruebas estad√≠sticas que generan un p-valor, un estad√≠stico de prueba y, en algunos casos, intervalos de confianza, los cuales permiten cuantificar la magnitud y direcci√≥n del efecto en la poblaci√≥n.

Dependiendo del tipo de variables involucradas, se aplican diferentes m√©todos:

-Para dos variables num√©ricas, se utilizan correlaciones de Pearson (si ambas variables siguen una distribuci√≥n normal) o Spearman (cuando no se cumple la normalidad).

-En el caso de combinaciones de una variable num√©rica y una categ√≥rica, se emplean pruebas como el t-test o Wilcoxon (para variables categ√≥ricas binarias), y ANOVA o Kruskal-Wallis (cuando hay m√°s de dos niveles en la variable categ√≥rica).

-Las relaciones entre dos variables categ√≥ricas se eval√∫an mediante pruebas de Chi-cuadrado, o en su defecto, Fisher exacta cuando los valores esperados en las celdas son bajos.

A continuaci√≥n, se ampl√≠a el an√°lisis previo de normalidad, pero desde una perspectiva bivariante, comparando las interacciones entre variables relevantes.

Por ejemplo, al representar un gr√°fico de dispersi√≥n entre EDAD_DIAGNOSTICO y TAMA√ëO, junto con una l√≠nea de tendencia, podemos identificar visualmente la presencia de una relaci√≥n entre ambas variables. Una pendiente positiva indicar√≠a una relaci√≥n directa, mientras que una pendiente negativa reflejar√≠a una relaci√≥n inversa. Adem√°s, el coeficiente de correlaci√≥n permite cuantificar esta relaci√≥n: valores cercanos a +1 indican una correlaci√≥n positiva fuerte, mientras que valores cercanos a ‚àí1 sugieren una correlaci√≥n negativa fuerte.

```{r, warning=FALSE, message=FALSE}
# Cargar librer√≠as necesarias
library(ggpubr)
library(dplyr)
library(moments)
library(ggplot2)

# Lista de variables num√©ricas
vars_num <- c("EDAD_DIAGNOSTICO", "TAMA√ëO", "GRADO", "RE", "RP", "Ki67", "ESTADIO")

# Crear dataframe para resultados
resultados_correlacion <- data.frame(
  Variable_1 = character(),
  Variable_2 = character(),
  Metodo = character(),
  Correlacion = numeric(),
  P_valor = numeric(),
  Interpretacion = character(),
  stringsAsFactors = FALSE
)

# Funci√≥n para evaluar normalidad
es_normal <- function(variable) {
  if (length(variable) > 50) {
    skewness_value <- skewness(variable, na.rm = TRUE)
    kurtosis_value <- kurtosis(variable, na.rm = TRUE)
    return(abs(skewness_value) < 2 & abs(kurtosis_value - 3) < 2)
  } else {
    return(shapiro.test(variable)$p.value > 0.05)
  }
}

# Bucle para an√°lisis de correlaci√≥n y generaci√≥n de gr√°ficos
for (i in 1:(length(vars_num)-1)) {
  for (j in (i+1):length(vars_num)) {
    var1 <- datos[[vars_num[i]]]
    var2 <- datos[[vars_num[j]]]
    
    # Evaluar normalidad
    normal1 <- es_normal(var1)
    normal2 <- es_normal(var2)
    metodo <- ifelse(normal1 & normal2, "pearson", "spearman")

    # Correlaci√≥n
    cor_test <- cor.test(var1, var2, method = metodo)
    cor_valor <- cor_test$estimate
    p_valor <- cor_test$p.value

    # Interpretaci√≥n
    interpretacion <- case_when(
      abs(cor_valor) >= 0.9 ~ "Muy fuerte",
      abs(cor_valor) >= 0.7 ~ "Fuerte",
      abs(cor_valor) >= 0.5 ~ "Moderada",
      abs(cor_valor) >= 0.3 ~ "D√©bil",
      TRUE ~ "Muy d√©bil o nula"
    )

    # Guardar resultado
    resultados_correlacion <- resultados_correlacion %>%
      add_row(
        Variable_1 = vars_num[i],
        Variable_2 = vars_num[j],
        Metodo = metodo,
        Correlacion = round(cor_valor, 3),
        P_valor = round(p_valor, 5),
        Interpretacion = interpretacion
      )

    # Generar gr√°fico de dispersi√≥n con regresi√≥n lineal
    p <- ggplot(datos, aes_string(x = vars_num[i], y = vars_num[j])) +
      geom_point(alpha = 0.5) +
      geom_smooth(method = "lm", color = "blue", se = FALSE) +
      labs(
        x = vars_num[i],
        y = vars_num[j],
        title = paste("Relaci√≥n entre", vars_num[i], "y", vars_num[j])
      ) +
      theme_minimal()

    print(p)
  }
}

# Mostrar tabla de resultados
print(resultados_correlacion)

```
Los resultados del an√°lisis bivariante muestran correlaciones que, en general, son coherentes con el conocimiento cl√≠nico actual sobre el c√°ncer de mama. La mayor√≠a de las asociaciones observadas son muy d√©biles o nulas, lo que sugiere que muchas de estas variables no est√°n directamente relacionadas de forma lineal, o bien que su efecto podr√≠a estar mediado por otros factores cl√≠nicos o moleculares.

Entre las relaciones m√°s relevantes, destaca una correlaci√≥n moderada entre TAMA√ëO y ESTADIO (r = 0.507, p < 0.001), lo cual es esperable, ya que el tama√±o del tumor es un componente directo del sistema de estadificaci√≥n TNM. Asimismo, se observa una relaci√≥n moderada entre RE y RP (r = 0.630), consistente con la coexpresi√≥n habitual de receptores hormonales en los tumores luminales.

-GRADO y Ki67 (r = 0.445): lo que indica que los tumores de mayor grado histol√≥gico presentan una mayor tasa de proliferaci√≥n celular, en l√≠nea con su biolog√≠a m√°s agresiva.

-RE y Ki67 (r = -0.422), y RP y Ki67 (r = -0.334): estas correlaciones negativas respaldan que a mayor proliferaci√≥n tumoral, menor expresi√≥n de receptores hormonales, lo cual es caracter√≠stico de tumores menos diferenciados.

-GRADO y RE (r = -0.366): lo que sugiere que los tumores de alto grado tienden a perder la expresi√≥n estrog√©nica, volvi√©ndose menos hormonodependientes.

Por otro lado, muchas de las correlaciones entre variables cl√≠nicas como EDAD_DIAGNOSTICO, TAMA√ëO, RE, RP o ESTADIO presentan valores cercanos a cero y no alcanzan significaci√≥n estad√≠stica, indicando ausencia de relaci√≥n lineal directa. Por ejemplo, la relaci√≥n entre EDAD_DIAGNOSTICO y TAMA√ëO fue pr√°cticamente nula (r = 0.018), y la mayor√≠a de los pares similares presentaron resultados similares.


```{r, warning=FALSE, message=FALSE}
# Cargar librer√≠as necesarias
library(dplyr)
library(ggpubr)
library(moments)
library(ggplot2)

# Obtener clases de columnas
tipos <- sapply(datos, class)

# Forzar TN y NX como factores (categ√≥ricas)
datos$Tn <- as.factor(datos$Tn)
datos$Nx <- as.factor(datos$Nx)


# Identificar variables num√©ricas y categ√≥ricas
vars_numericas <- names(tipos)[tipos %in% c("numeric", "integer")]
vars_categoricas <- names(tipos)[tipos %in% c("character", "factor")]

# Crear combinaciones v√°lidas: num√©rica vs categ√≥rica
vars_num_cat <- expand.grid(
  Variable_Numerica = vars_numericas,
  Variable_Categorica = vars_categoricas,
  stringsAsFactors = FALSE
) %>%
  filter(Variable_Numerica != Variable_Categorica)

# Crear un dataframe para guardar resultados
resultados_num_cat <- data.frame(
  Variable_Numerica = character(),
  Variable_Categorica = character(),
  Metodo = character(),
  Estadistico = numeric(),
  P_valor = numeric(),
  Interpretacion = character(),
  stringsAsFactors = FALSE
)

# Funci√≥n para evaluar normalidad
es_normal <- function(variable) {
  if (!is.numeric(variable)) return(FALSE)
  variable <- na.omit(variable)
  if (length(variable) == 0) return(FALSE)
  
  if (length(variable) > 50) {
    skewness_value <- skewness(variable)
    kurtosis_value <- kurtosis(variable)
    return(abs(skewness_value) < 2 & abs(kurtosis_value - 3) < 2)
  } else {
    return(shapiro.test(variable)$p.value > 0.05)
  }
}

# Bucle principal
for (i in seq_len(nrow(vars_num_cat))) {
  var_num_name <- vars_num_cat$Variable_Numerica[i]
  var_cat_name <- vars_num_cat$Variable_Categorica[i]
  
  var_num <- datos[[var_num_name]]
  var_cat <- as.factor(datos[[var_cat_name]])
  
  # Validaci√≥n
  if (!is.numeric(var_num) || length(unique(na.omit(var_cat))) < 2) next
  
  metodo <- ""
  estadistico <- NA
  p_valor <- NA
  interpretacion <- ""
  
  normal <- es_normal(var_num)
  
  # Test seg√∫n n√∫mero de niveles
  if (length(unique(var_cat)) == 2) {
    try({
      if (normal) {
        test <- t.test(var_num ~ var_cat)
        metodo <- "T-test"
        estadistico <- test$statistic
        p_valor <- test$p.value
      } else {
        test <- wilcox.test(var_num ~ var_cat)
        metodo <- "Wilcoxon"
        estadistico <- test$statistic
        p_valor <- test$p.value
      }
    }, silent = TRUE)
    
    # üü¢ SOLO generar boxplot si la variable categ√≥rica es RCP_1
    if (var_cat_name == "RCP_1") {
      p <- datos %>%
        filter(!is.na(.data[[var_cat_name]]), !is.na(.data[[var_num_name]])) %>%
        ggplot(aes_string(x = var_cat_name, y = var_num_name, fill = var_cat_name)) +
        geom_boxplot() +
        stat_compare_means(method = metodo) +
        labs(
          title = paste("Distribuci√≥n de", var_num_name, "seg√∫n", var_cat_name),
          x = var_cat_name,
          y = var_num_name,
          fill = var_cat_name
        ) +
        theme_minimal()
      
      print(p)
    }
    
  } else {
    # M√°s de dos niveles
    try({
      if (normal) {
        modelo <- aov(var_num ~ var_cat)
        resumen <- summary(modelo)[[1]]
        metodo <- "ANOVA"
        estadistico <- resumen[["F value"]][1]
        p_valor <- resumen[["Pr(>F)"]][1]
      } else {
        test <- kruskal.test(var_num ~ var_cat)
        metodo <- "Kruskal-Wallis"
        estadistico <- test$statistic
        p_valor <- test$p.value
      }
    }, silent = TRUE)
  }
  
  if (!is.na(p_valor)) {
    interpretacion <- case_when(
      p_valor < 0.001 ~ "Diferencia muy significativa",
      p_valor < 0.01  ~ "Diferencia significativa",
      p_valor < 0.05  ~ "Diferencia marginalmente significativa",
      TRUE            ~ "No hay diferencia significativa"
    )
    
    resultados_num_cat <- resultados_num_cat %>%
      add_row(
        Variable_Numerica = var_num_name,
        Variable_Categorica = var_cat_name,
        Metodo = metodo,
        Estadistico = round(estadistico, 3),
        P_valor = round(p_valor, 5),
        Interpretacion = interpretacion
      )
  }
}

# Mostrar tabla de resultados
print(resultados_num_cat)



```
Con base en los 200 an√°lisis,muchas asociaciones no resultaron estad√≠sticamente significativas, lo cual es com√∫n en contextos cl√≠nicos con m√∫ltiples factores interrelacionados. Sin embargo, destacan varias asociaciones especialmente en variables relevantes como `GRADO`, `RE`, `RP` y `Ki67` frente a categor√≠as como `FENOTIPO_IHQ`, `RCB`, `GRADO_CAT`, `HT_ADY_OK`, o `KI67_DICOT`, lo que confirma que tumores de mayor agresividad tienden a tener mayor proliferaci√≥n celular (Ki67) y menor expresi√≥n de receptores hormonales (RE y RP).

Por ejemplo, `Ki67` mostr√≥ diferencias muy significativas seg√∫n `GRADO_CAT`, `FENOTIPO_IHQ`, y `RCP_1`, lo que refuerza su valor como marcador pron√≥stico. `RE` tambi√©n present√≥ diferencias claras frente a `HER2_CAT`, `RCB` y `HT_ADY_OK`, reflejando la relaci√≥n inversa entre receptor hormonal y agresividad tumoral. Adem√°s, variables como `TAMA√ëO` y `ESTADIO` tambi√©n mostraron diferencias muy significativas frente a categor√≠as como `Tn`, `Nx`, y `RCP_1`, apoyando su inclusi√≥n en modelos predictivos.

En contraste, muchas otras asociaciones como `EDAD_DIAGNOSTICO` con m√∫ltiples variables categ√≥ricas no resultaron significativas, lo que indica que la edad al diagn√≥stico no siempre impacta directamente en las caracter√≠sticas biol√≥gicas del tumor. Tambi√©n destaca que `No_ANTIBIOTICOS` rara vez mostr√≥ diferencias significativas, salvo en su relaci√≥n con `ANTIBIOTICO` (como era esperable), lo que sugiere una influencia limitada del n√∫mero de tandas de antibi√≥ticos, al menos de forma univariante.

Sin embargo, s√≠ se detect√≥ asociaci√≥n significativa importante: el valor de p para la relaci√≥n entre Tn (el tama√±o tumoral cl√≠nico) y FECHA_DIAGNOSTICO fue 0.00097, lo que indica una diferencia muy significativa. Esto podr√≠a interpretarse como una tendencia temporal en el tama√±o del tumor al momento del diagn√≥stico, posiblemente influenciada por cambios en el diagn√≥stico precoz, el acceso a servicios de salud o modificaciones en los criterios cl√≠nicos a lo largo del tiempo.

Finalmente, se sugiere que los pacientes con tumores m√°s peque√±os tienen mayor probabilidad de alcanzar una RCP.

En cuanto a los boxplots, apreciamos diferencias notables en varias variables en funci√≥n de la respuesta completa patol√≥gica (`RCP_1`). Se observa, por ejemplo, que los pacientes que lograron una RCP (`SI`) tienden a tener tumores m√°s peque√±os en comparaci√≥n con quienes no lo lograron (`NO`), lo cual es consistente con la literatura cl√≠nica. En otro, los niveles de receptores de progesterona (`RP`) son visiblemente m√°s altos en pacientes sin RCP, mientras que en los que s√≠ respondieron completamente, los valores de `RP` son cercanos a cero. Esto sugiere que una baja expresi√≥n hormonal podr√≠a estar asociada a una mejor respuesta a la quimioterapia, un patr√≥n compatible con fenotipos m√°s agresivos (como los triple negativos) que suelen responder mejor a estos esquemas. Ambas visualizaciones refuerzan hallazgos cl√≠nicamente relevantes.

```{r, warning=FALSE, message=FALSE}
# Cargar librer√≠as necesarias
library(dplyr)
library(ggplot2)
library(rlang)

# 1. Limpiar nombres de columnas de saltos de l√≠nea
names(datos) <- gsub("[\\n\\r]", "", names(datos))

# 2. Vector de variables categ√≥ricas de inter√©s
vars_cat_names <- c("RCP_1", "HT_ADY_OK", "RECIDIVA", "ESTADO_ULTIMO_CONTROL", "SEXO",
                    "ESTADO_MENOPAUSICO", "TIPO_CIRUGIA", "RT", "TAMA√ëO_CAT",
                    "GRADO_CAT", "Ki67_CAT", "ESTADIO_CAT", "Tn", "Nx")

# 3. Generar todas las combinaciones posibles de pares (sin repeticiones)
vars_cat <- combn(vars_cat_names, 2, simplify = FALSE)

# 4. Filtrar combinaciones que realmente existen en el dataset
vars_cat <- vars_cat[sapply(vars_cat, function(pair) all(pair %in% colnames(datos)))]


# 4. Crear dataframe vac√≠o para almacenar resultados
resultados <- data.frame(
  Variable_1 = character(),
  Variable_2 = character(),
  Metodo = character(),
  P_valor = numeric(),
  Interpretacion = character(),
  stringsAsFactors = FALSE
)

# 5. Bucle por cada par de variables
for (pair in vars_cat) {
  var1 <- pair[1]
  var2 <- pair[2]
  
  # Filtrar filas sin NA en las dos variables
  df_sub <- datos %>% filter(!is.na(.data[[var1]]) & !is.na(.data[[var2]]))
  
  # Crear tabla de contingencia
  tabla <- table(df_sub[[var1]], df_sub[[var2]])
  
  # TEST: Chi-cuadrado o Fisher con fallback a simulaci√≥n
  if (any(chisq.test(tabla)$expected <= 5)) {
    test_result <- tryCatch({
      fisher.test(tabla)
    }, error = function(e) {
      fisher.test(tabla, simulate.p.value = TRUE, B = 5000)
    })
    metodo <- "Fisher"
  } else {
    test_result <- chisq.test(tabla)
    metodo <- "Chi-cuadrado"
  }

  # A√±adir resultados al dataframe
  resultados <- rbind(resultados, data.frame(
    Variable_1 = var1,
    Variable_2 = var2,
    Metodo = metodo,
    P_valor = round(test_result$p.value, 5),
    Interpretacion = ifelse(test_result$p.value < 0.05, "‚úÖ Significativa", "‚ùå No significativa")
  ))

  # 6. Gr√°fico de barras si una de las variables es RCP_1
  if ("RCP_1" %in% pair) {
    var_x <- ifelse(var1 == "RCP_1", var2, var1)
    
    grafico <- ggplot(df_sub, aes(x = !!sym(var_x), fill = RCP_1)) +
      geom_bar(position = "fill") +
      labs(
        title = paste("Distribuci√≥n de RCP_1 por", var_x),
        y = "Proporci√≥n", x = var_x, fill = "RCP_1"
      ) +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5))

    print(grafico)
  }
}

# 7. Mostrar resultados ordenados por significancia
resultados <- resultados %>% arrange(P_valor)
print(resultados)


```

Cuando se analizan dos variables categ√≥ricas, como la respuesta al tratamiento (RCP_1) y el grado del tumor (GRADO_CAT), empleamos tablas de contingencia para visualizar la distribuci√≥n de los datos y pruebas estad√≠sticas como el test de Chi-cuadrado o Fisher para determinar la significancia de las diferencias. En este caso, la tabla de contingencia muestra una diferencia en la distribuci√≥n de la respuesta entre los niveles de GRADO_CAT. 

El an√°lisis de asociaci√≥n entre variables categ√≥ricas revela m√∫ltiples relaciones cl√≠nicamente relevantes. La respuesta completa patol√≥gica (RCP_1) muestra una asociaci√≥n estad√≠sticamente significativa con la hormonoterapia adyuvante (HT_ADY_OK) (p ‚âà 0.0002) y una relaci√≥n altamente significativa con la recidiva tumoral (RECIDIVA) (p < 0.00000002). Estos resultados sugieren que alcanzar una RCP podr√≠a estar relacionado con una menor probabilidad de recurrencia y una mayor indicaci√≥n de hormonoterapia.

Asimismo, HT_ADY_OK tambi√©n se asocia con RECIDIVA (p ‚âà 0.0216), lo cual puede indicar un efecto protector del tratamiento hormonal frente a la reca√≠da. En l√≠nea con la pr√°ctica cl√≠nica, se observa una fuerte relaci√≥n entre el estado menop√°usico y el uso de hormonoterapia (p ‚âà 0.0002), reflejando el criterio terap√©utico habitual seg√∫n el perfil hormonal del paciente.

El tipo de cirug√≠a (TIPO_CIRUGIA) tambi√©n se asocia significativamente con la recidiva (p ‚âà 0.0043), posiblemente indicando que ciertos abordajes quir√∫rgicos podr√≠an estar ligados a un mayor o menor riesgo de recurrencia. Por otra parte, se identifica una asociaci√≥n significativa entre el grado tumoral (GRADO_CAT) y la recidiva (p ‚âà 0.0022), lo que sugiere que tumores de alto grado histol√≥gico podr√≠an presentar un comportamiento m√°s agresivo.

Adem√°s, el √≠ndice proliferativo (Ki67_CAT) se relaciona con el uso de hormonoterapia (p ‚âà 0.0002), reforzando su papel como biomarcador en la toma de decisiones terap√©uticas. Por el contrario, algunas asociaciones no resultaron significativas, como el sexo (SEXO) con RCP_1 (p = 1) y el tama√±o categorizado del tumor (TAMA√ëO_CAT) con RCP_1 (p ‚âà 0.319), indicando que estas variables no muestran relaci√≥n directa con la respuesta al tratamiento en este an√°lisis.

Finalmente, destaca la fuerte asociaci√≥n entre el estadio cl√≠nico (ESTADIO_CAT) y la indicaci√≥n de radioterapia (RT) (p < 1e-80), lo cual refleja que las decisiones terap√©uticas est√°n fuertemente influenciadas por la extensi√≥n tumoral.

*Conclusi√≥n*:A partir del conjunto de an√°lisis bivariantes realizados (correlaciones entre variables num√©ricas, comparaciones entre variables num√©ricas y categ√≥ricas, y asociaciones entre pares de variables categ√≥ricas), se observa un patr√≥n cl√≠nico claro: tumores de mayor agresividad proliferativa tienden a mostrar menor expresi√≥n hormonal, peor pron√≥stico y peor respuesta, mientras que tumores menos diferenciados y con baja carga hormonal responden mejor a la quimioterapialosz, especialmente en perfiles como el triple negativo. 


# Analisis Multivariante

Por ahora, hemos explorado la relaci√≥n entre la respuesta completa patol√≥gica (RCP) y otras variables del conjunto de datos utilizando an√°lisis bivariantes, tanto de asociaci√≥n como de correlaci√≥n. Si bien este tipo de an√°lisis resulta √∫til como primer acercamiento para identificar posibles v√≠nculos, presenta limitaciones sustanciales cuando se trata de comprender en profundidad qu√© factores influyen realmente en la probabilidad de alcanzar una RCP.

Una de las principales debilidades del enfoque bivariante es que analiza cada variable por separado, ignorando el contexto en el que interact√∫an m√∫ltiples factores simult√°neamente. Esto puede llevar a conclusiones enga√±osas. Por ejemplo, podr√≠amos observar una aparente relaci√≥n entre el uso de antibi√≥ticos y la RCP, sin tener en cuenta que dicha relaci√≥n podr√≠a estar mediada o explicada por otra variable relevante, como el tipo de quimioterapia administrada. Sin un ajuste por variables concurrentes, este tipo de interpretaciones corre el riesgo de sobreestimar o subestimar efectos reales.

Adem√°s, este enfoque no permite identificar interacciones entre variables. Es posible que el impacto de un factor sobre la RCP no sea uniforme, sino que dependa del nivel de otra variable. Por ejemplo, el efecto del fenotipo tumoral sobre la respuesta podr√≠a variar seg√∫n el estado menop√°usico de la paciente. Estas interacciones complejas solo pueden detectarse y cuantificarse adecuadamente mediante un an√°lisis multivariante.

Tambi√©n debemos considerar el problema de la colinealidad: cuando dos o m√°s variables est√°n correlacionadas entre s√≠, el an√°lisis bivariante no puede discernir cu√°l es la que ejerce realmente el efecto. Esto puede inducir a atribuir err√≥neamente la influencia de una variable a otra relacionada. El an√°lisis multivariante permite controlar esta colinealidad y distinguir los efectos independientes de cada predictor.

Por √∫ltimo, los an√°lisis bivariantes ofrecen estimaciones ‚Äúcrudas‚Äù, es decir, no ajustadas por el resto de variables. En cambio, los modelos multivariantes proporcionan odds ratios ajustados, que representan con mayor fidelidad la influencia real de cada factor sobre la probabilidad de lograr una RCP, controlando por otras covariables.

Por todas estas razones, avanzar hacia un an√°lisis multivariante no solo es un paso l√≥gico, sino necesario. Este enfoque nos permitir√° obtener una visi√≥n m√°s completa y precisa del fen√≥meno cl√≠nico que estudiamos, identificando los verdaderos determinantes de la respuesta patol√≥gica completa, evaluando interacciones relevantes y estimando con mayor exactitud las probabilidades de √©xito terap√©utico.

### Regresi√≥n lineal
Una vez analizadas las relaciones entre variables mediante m√©todos bivariantes y regresi√≥n lineal, resulta evidente que necesitamos un enfoque m√°s adecuado para modelar eventos cl√≠nicos dicot√≥micos, como la respuesta completa patol√≥gica (RCP). La regresi√≥n lineal, aunque √∫til para variables continuas, no es apropiada cuando el resultado a predecir es binario, ya que puede producir valores de probabilidad fuera del rango v√°lido de 0 a 1. Por ejemplo, si intentamos modelar la probabilidad de RCP en funci√≥n del √≠ndice Ki67 con una regresi√≥n lineal, obtendremos un modelo como mod.lin <- lm((RCP=="SI") ~ Ki67, data = datos), cuyo resumen (summary(mod.lin)) muestra un coeficiente positivo y significativo para Ki67. Sin embargo, al realizar predicciones con este modelo (predict(mod.lin, data.frame(Ki67 = c(-50, 0, 15, 50, 120)))), observamos valores negativos o superiores a 1, lo cual es il√≥gico desde un punto de vista probabil√≠stico.
```{r}
modelo <- glm((RCP_1 == "SI") ~ TAMA√ëO + GRADO_CAT + ANTIBIOTICO, data = datos, family = binomial)
summary(modelo)

mod.lin <- lm((RCP_1=="SI") ~ Ki67, data = datos)
predict(mod.lin, data.frame(Ki67 = c(-50, 0, 15, 50, 120, 250)))

plot(datos$Ki67, datos$RCP_1=="SI")
abline(mod.lin, col = "red")
```
por lo tanto, necesitamos una funci√≥n que sea siempre positiva, como, por ejemplo, la funci√≥n exponencial negativa.
```{r}

tama <- seq(-30,30,2)
plot(tama, exp(0.0372316+0.1652255*tama))
```



Pero tambi√©n que produzca valores en el rango {0,1}, por lo que dividimos la funci√≥n exponencial entre ‚Äúalgo‚Äù un poquito m√°s grande que la propia exponencial.
```{r}

plot(tama, exp(0.0372316+0.1652255*tama)/(1+exp(0.0372316+0.1652255*tama)))
```
Igualmente probemos un poco de codigo lineal:
```{r, warning=FALSE}
library(ggplot2)

# Variables que quieres evaluar como predictoras de TAMA√ëO
vars_numericas <- c("Ki67", "EDAD_DIAGNOSTICO", "No_ANTIBIOTICOS", "RE", "RP")

# Bucle por cada variable
for (var in vars_numericas) {
  cat("\n==============================\n")
  cat("üìä Evaluando:", var, "como predictor de TAMA√ëO\n")

  # Verificar si la variable es num√©rica
  if (is.numeric(datos[[var]])) {
    # Modelo lineal
    formula_str <- as.formula(paste("TAMA√ëO ~", var))
    mod_lin <- lm(formula_str, data = datos)
    resumen <- summary(mod_lin)

    # Extraer valores clave
    coeficiente <- resumen$coefficients[2, 1]
    p_valor <- resumen$coefficients[2, 4]
    r2 <- resumen$r.squared

    # Interpretaci√≥n
    direccion <- ifelse(coeficiente > 0, "positiva", "negativa")
    significancia <- ifelse(p_valor < 0.05, "‚úÖ Significativa", "‚ùå No significativa")

    cat("üîπ Coeficiente:", round(coeficiente, 4), "‚Üí Relaci√≥n", direccion, "\n")
    cat("üîπ p-valor:", round(p_valor, 5), "‚Üí", significancia, "\n")
    cat("üîπ R¬≤:", round(r2, 3), "‚Üí", ifelse(r2 > 0.3, "‚úî Explica bastante", "‚ùó Explica poco"), "\n")

    # Gr√°fico solo si ambas son num√©ricas
    plot(datos[[var]], datos$TAMA√ëO,
         main = paste("Relaci√≥n entre", var, "y TAMA√ëO"),
         xlab = var, ylab = "TAMA√ëO",
         col = "darkblue", pch = 19)
    abline(mod_lin, col = "red", lwd = 2)

    # Predicci√≥n con valores te√≥ricos
    nuevos_valores <- data.frame()
    if (var == "Ki67") {
      nuevos_valores <- data.frame(Ki67 = c(-50, 0, 15, 50, 120, 200))
    } else {
      nuevos_valores <- data.frame(x = seq(min(datos[[var]], na.rm = TRUE),
                                           max(datos[[var]], na.rm = TRUE),
                                           length.out = 5))
      names(nuevos_valores) <- var
    }

    predicciones <- predict(mod_lin, newdata = nuevos_valores)
    cat("üîÆ Predicciones para valores de", var, ":\n")
    print(data.frame(nuevos_valores, Prediccion_Tama√±o = round(predicciones, 2)))
  } else {
    cat("La variable", var, "no es num√©rica. No se puede ajustar modelo lineal ni graficar.\n")
  }
}

```

Se realizaron regresiones lineales simples del tipo TAMA√ëO ~ X. En cada caso, se interpret√≥ el signo del coeficiente (para identificar si la relaci√≥n era positiva o negativa), el p-valor (para valorar significancia estad√≠stica) y el R¬≤ (para cuantificar cu√°nta variabilidad del tama√±o explica la variable predictora).

Los resultados muestran que:

EDAD_DIAGNOSTICO tiene una relaci√≥n positiva d√©bil con TAMA√ëO (coef. = 0.0027), pero no significativa (p = 0.676), y un R¬≤ ‚âà 0, por lo que no se considera un buen predictor.

No_ANTIBIOTICOS presenta una relaci√≥n negativa leve con TAMA√ëO (coef. = -0.0818), pero tampoco significativa (p = 0.336), y su R¬≤ es muy bajo (0.001), lo que indica nula capacidad explicativa.

RE y RP, marcadores hormonales, muestran coeficientes positivos m√≠nimos, sin significancia estad√≠stica (p > 0.7) ni capacidad predictiva (R¬≤ ‚âà 0). Por tanto, se descartan como predictores de TAMA√ëO en este contexto.

## Regresi√≥n log√≠stica

Este problema se soluciona utilizando regresi√≥n log√≠stica, una t√©cnica espec√≠ficamente dise√±ada para variables dependientes binarias. Esta metodolog√≠a transforma la combinaci√≥n lineal de los predictores en probabilidades v√°lidas usando una funci√≥n log√≠stica (o sigmoidea), que restringe los valores entre 0 y 1. En lugar de modelar directamente la media de la variable dependiente, la regresi√≥n log√≠stica estima la probabilidad de ocurrencia del evento en funci√≥n de las variables explicativas. Por tanto, en nuestro contexto, el modelo estima la probabilidad de que un paciente logre una RCP en funci√≥n de factores cl√≠nicos como el tama√±o del tumor, el grado histol√≥gico y el uso de antibi√≥ticos.

Los coeficientes del modelo indican la direcci√≥n y magnitud de esta relaci√≥n: un valor positivo implica que a medida que aumenta la variable predictora, tambi√©n lo hace la probabilidad de RCP, mientras que un coeficiente negativo indica lo contrario. Estos efectos se interpretan m√°s f√°cilmente a trav√©s del odds ratio (OR), que cuantifica cu√°nto se multiplican las probabilidades de respuesta por cada unidad de cambio en la variable independiente. Por ejemplo, un OR menor a 1 indica una disminuci√≥n en la probabilidad del evento, y uno mayor a 1, un aumento. La significancia estad√≠stica de cada predictor se eval√∫a con el p-valor: si es menor a 0.05, el efecto se considera significativo. Adem√°s, la devianza residual y el AIC se utilizan para evaluar la calidad del modelo: cuanto m√°s bajos, mejor ajuste. 

Ahora, ajustamos un modelo con el siguiente c√≥digo:

```{r}
modelo <- glm((RCP_1 == "SI") ~ TAMA√ëO + GRADO_CAT + ANTIBIOTICO, data = datos, family = binomial)
summary(modelo)
```

El intercepto del modelo tiene un valor negativo significativo (‚àí0.72107, p ‚âà 0.00075), lo que indica que, en condiciones de referencia (tumores de grado 1/2 y sin antibi√≥ticos, con tama√±o igual a 0), la probabilidad base de lograr una RCP es baja.

En cuanto al tama√±o del tumor, su coeficiente (‚àí0.09892, p ‚âà 0.0287) es negativo y significativo, lo que sugiere que a mayor tama√±o tumoral, menor probabilidad de alcanzar una RCP. Al convertirlo a OR ‚Üí exp(‚àí0.09892) ‚âà 0.906, se concluye que por cada cm adicional en el tama√±o del tumor, los odds de RCP disminuyen aproximadamente un 9.4%, lo cual es cl√≠nicamente coherente.

En la salida del modelo de regresi√≥n log√≠stica, el t√©rmino `GRADO_CAT3` aparece porque R convierte autom√°ticamente las variables categ√≥ricas en variables indicadoras (tambi√©n llamadas dummies) al construir el modelo. En este caso, la variable `GRADO_CAT` tiene dos niveles: `"1/2"` y `"3"`. R toma por defecto el primer nivel como referencia (en este caso `"1/2"`) y crea una nueva variable binaria (`GRADO_CAT3`) que vale 1 cuando el tumor es de grado 3 y 0 cuando es de grado 1 o 2. Por tanto, el coeficiente estimado para `GRADO_CAT3` refleja el cambio en los log-odds de alcanzar una respuesta completa patol√≥gica (RCP) cuando el tumor es de grado 3 en comparaci√≥n con el grupo de referencia (grado 1/2). Esta codificaci√≥n es est√°ndar en regresi√≥n log√≠stica y permite interpretar f√°cilmente los efectos de cada categor√≠a respecto a la base.

Para el grado histol√≥gico, se observa que los tumores de grado 3 tienen un coeficiente positivo y altamente significativo (0.73212, p < 0.0001), con un OR ‚âà exp(0.73212) ‚âà 2.08. Esto significa que los pacientes con tumores de grado 3 tienen m√°s del doble de odds de lograr una RCP en comparaci√≥n con aquellos de grado 1 o 2. Este hallazgo sugiere que, aunque los tumores de alto grado son m√°s agresivos, tambi√©n podr√≠an ser m√°s sensibles a la quimioterapia.

Por su parte, el uso de antibi√≥ticos (categor√≠a "SI") muestra un coeficiente negativo (‚àí0.26980), lo cual indicar√≠a una disminuci√≥n en la probabilidad de RCP; sin embargo, esta asociaci√≥n no es estad√≠sticamente significativa (p ‚âà 0.116), por lo que no se puede concluir con seguridad que el uso de antibi√≥ticos influya directamente en la respuesta completa.

El modelo presenta una reducci√≥n moderada en la devianza (de 870.73 a 846.16), lo que sugiere que los predictores aportan cierta capacidad explicativa respecto a la variable dependiente. El AIC (854.16) puede utilizarse como referencia para comparar este modelo con otros m√°s complejos o simplificados.

En resumen, este modelo confirma que tanto el tama√±o tumoral como el grado histol√≥gico son predictores estad√≠sticamente significativos de la respuesta completa patol√≥gica, mientras que el uso de antibi√≥ticos, aunque presenta una tendencia negativa, no alcanza significancia estad√≠stica. Estos hallazgos refuerzan la importancia de estos factores en la estratificaci√≥n cl√≠nica y el dise√±o de estrategias terap√©uticas personalizadas.

Este an√°lisis pone en evidencia una de las grandes ventajas del enfoque multivariante: permite evaluar el efecto de cada variable ajustando por el resto, corrigiendo as√≠ posibles sesgos de confusi√≥n. Adem√°s, nos permite detectar relaciones que no ser√≠an visibles en an√°lisis por separado. 
Esta informaci√≥n es clave para seleccionar variables en un modelo multivariante m√°s robusto y evitar introducir ruido al incluir variables no significativas o redundantes.


### Selecci√≥n de Variables con Regresi√≥n Stepwise en R

Tras el an√°lisis bivariante exhaustivo presentado en secciones anteriores identificamos un conjunto de variables cl√≠nicamente relevantes y estad√≠sticamente significativas en relaci√≥n con la respuesta completa patol√≥gica (RCP_1). Las variables con mayor consistencia estad√≠stica y sustento cl√≠nico fueron: TAMA√ëO, GRADO_CAT, Ki67_CAT, HT_ADY_OK, ANTIBIOTICO, FENOTIPO_IHQ, RT, Tn, Nx.

Para la construcci√≥n del modelo, utilizamos el procedimiento de selecci√≥n de variables stepwise (por pasos), una t√©cnica iterativa que permite construir un modelo parsimonioso y estad√≠sticamente √≥ptimo. Esta metodolog√≠a eval√∫a sistem√°ticamente el impacto de a√±adir o eliminar cada variable candidata con base en un criterio de informaci√≥n: en este caso, el Akaike Information Criterion (AIC). Cuanto menor es el AIC, mejor es el balance entre calidad del ajuste y complejidad del modelo.Existen tres variantes:

-*Forward selection*: parte de un modelo vac√≠o e incorpora variables una a una si mejoran el ajuste.

-*Backward elimination*: parte del modelo completo y elimina variables si su exclusi√≥n mejora el AIC.

-*Stepwise (bidireccional)*: combina los dos m√©todos anteriores, a√±adiendo o eliminando variables seg√∫n el ajuste.
```{r, warning=FALSE}
library(MASS)

# Codificaci√≥n binaria de la variable dependiente
datos$RCP_bin <- ifelse(datos$RCP_1 == "SI", 1, 0)

# Modelo nulo (sin predictores)
modelo_null <- glm(RCP_bin ~ 1, data = datos, family = binomial)

# Modelo completo con variables seleccionadas del an√°lisis bivariante
modelo_full <- glm(RCP_bin ~ TAMA√ëO + GRADO_CAT + ANTIBIOTICO + FENOTIPO_IHQ + T + RT ,
                   data = datos, family = binomial)



# Aplicaci√≥n de los tres m√©todos de selecci√≥n
modelo_forward <- stepAIC(modelo_null, 
                          scope = list(lower = modelo_null, upper = modelo_full), 
                          direction = "forward")

modelo_backward <- stepAIC(modelo_full, direction = "backward")

modelo_both <- stepAIC(modelo_null, 
                       scope = list(lower = modelo_null, upper = modelo_full), 
                       direction = "both")


```
Este modelo mostr√≥ un AIC final de 794.56, una mejora sustancial frente al AIC del modelo nulo (872.73). A lo largo del proceso iterativo, se evalu√≥ la contribuci√≥n individual de cada variable. En cada paso, se mantuvieron √∫nicamente aquellas cuyo aporte reduc√≠a el AIC, es decir, aquellas que aumentaban la capacidad explicativa del modelo sin incrementar innecesariamente su complejidad.

En particular, FENOTIPO_IHQ fue la primera variable seleccionada, mostrando un efecto muy fuerte en la reducci√≥n del AIC (de 872.73 a 804.07), seguida por GRADO_CAT, TAMA√ëO y, finalmente, ANTIBIOTICO. Por el contrario, variables como RT o T no lograron una reducci√≥n suficiente del AIC y fueron descartadas del modelo final, indicando un efecto marginal o dependiente de otras variables ya incluidas.
```{r}
# Comparaci√≥n de modelos por AIC
AIC(modelo_forward, modelo_backward, modelo_both)


```
De forma consistente, los tres m√©todos convergieron hacia el mismo modelo √≥ptimo, compuesto por las variables TAMA√ëO, GRADO_CAT, ANTIBIOTICO y FENOTIPO_IHQ, con un AIC final de 794.56. Esta coincidencia entre algoritmos confirma que el modelo seleccionado es estad√≠sticamente robusto, y que la inclusi√≥n o exclusi√≥n de otras variables no mejora significativamente la capacidad predictiva ni reduce la p√©rdida de informaci√≥n. Este modelo ser√°, por tanto, la base para la interpretaci√≥n cl√≠nica y la estimaci√≥n de efectos ajustados mediante odds ratios.
```{r}
# Mostrar resultados de cada modelo
cat("\n=== MODELO FORWARD SELECTION ===\n")
summary(modelo_forward)

cat("\n=== MODELO BACKWARD ELIMINATION ===\n")
summary(modelo_backward)

cat("\n=== MODELO STEPWISE BOTH DIRECTIONS ===\n")
summary(modelo_both)
```

FENOTIPO_IHQ: En comparaci√≥n con el fenotipo de referencia (Her2+), tanto los subtipos Luminal como Triple Negativo presentaron coeficientes negativos significativos (p < 0.001), lo que indica una menor probabilidad de RCP en comparaci√≥n con el grupo de referencia. Esto es coherente con la biolog√≠a de los tumores luminales, que suelen tener una menor tasa de respuesta patol√≥gica completa.

GRADO_CAT3: Los tumores de grado 3 mostraron una mayor probabilidad de RCP (OR > 1, p = 0.0046), lo que refuerza su perfil proliferativo y su sensibilidad al tratamiento neoadyuvante, especialmente en subtipos m√°s agresivos.

TAMA√ëO: Cada aumento de 1 cm en el tama√±o tumoral se asoci√≥ con una disminuci√≥n significativa en la probabilidad de alcanzar RCP (p = 0.0148). 

ANTIBIOTICO: Aunque esta variable mostr√≥ una tendencia negativa hacia la RCP, su valor p fue de 0.089, ligeramente por encima del umbral convencional de significancia. Si bien no es concluyente, su inclusi√≥n en el modelo puede aportar valor en an√°lisis m√°s complejos o ajustados.

Intercepto: El valor positivo del intercepto indica que, en ausencia de los factores de riesgo descritos, la probabilidad base de RCP en el grupo de referencia es relativamente moderada.

AIC: 794.56, significativamente menor que el AIC inicial del modelo nulo (872.73), indicando una mejora sustancial en la calidad del ajuste sin sobreajuste.

Residual deviance: 782.56, lo que sugiere un ajuste razonable para la complejidad del modelo.

N√∫mero de observaciones: 699, sin indicios de problemas graves de sobreajuste o colinealidad, dado que el n√∫mero de predictores es limitado

```{r}
modelo_step <- modelo_backward

# Paso 1: Odds Ratios e intervalos de confianza
exp(cbind(OddsRatio = coef(modelo_step), confint(modelo_step)))

# Paso 2: Visualizar OR con ggplot2
OR <- exp(coef(modelo_step))
CI <- exp(confint(modelo_step))
or_df <- data.frame(
  Variable = names(OR),
  OR = OR,
  CI_lower = CI[, 1],
  CI_upper = CI[, 2]
)

library(ggplot2)
ggplot(or_df[-1, ], aes(x = Variable, y = OR)) +  # Excluimos el intercepto
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), width = 0.2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  ylab("Odds Ratio (OR)") + xlab("") +
  ggtitle("Odds Ratios con intervalos de confianza (95%)") +
  theme_minimal()

# Paso 3: Evaluar el desempe√±o del modelo con curva ROC
library(pROC)
roc_obj <- roc(datos$RCP_1, fitted(modelo_step))
plot(roc_obj, col = "darkgreen", lwd = 2, main = "Curva ROC del modelo final")
auc(roc_obj)  # √Årea bajo la curva (AUC)

```
Aqui podemos ver la curva ROC, obteniendo un AUC elevado. Esta √°rea bajo la curva refleja una buena discriminaci√≥n del modelo para predecir la probabilidad de respuesta completa patol√≥gica (RCP).

Por otro lado, el gr√°fico de odds ratios con intervalos de confianza al 95% nos da confianza sobre nuestros resultados. 

Antes de darnos por satisfechos, haria falta tambien analizarlosin catergorizar las variables num√©ricas, para ver si el modelo funciona mejor. 



```{r}
# Cargar librer√≠as necesarias
library(MASS)



# Ajustar el modelo log√≠stico con variables num√©ricas sin categorizar
modelo_numerico <- glm(RCP_bin ~ TAMA√ëO + Ki67 + EDAD_DIAGNOSTICO + GRADO + RE + RP, 
                       data = datos, 
                       family = binomial)

# Ver resumen del modelo
summary(modelo_numerico)

# Aplicar selecci√≥n autom√°tica de variables (backward)
modelo_numerico_back <- stepAIC(modelo_numerico, direction = "backward")

# Mostrar resumen del modelo final
summary(modelo_numerico_back)

```
Esta comparaci√≥n responde a una necesidad metodol√≥gica clave: determinar si la transformaci√≥n de variables (como el tama√±o tumoral, los receptores hormonales o el √≠ndice Ki67) en categor√≠as cl√≠nicas aporta claridad interpretativa sin comprometer el ajuste del modelo, o si, por el contrario, implica una p√©rdida de informaci√≥n que afecta su rendimiento predictivo. Los resultados muestran que el modelo con variables continuas presenta un AIC menor (781.99) frente al modelo con variables categorizadas (AIC = 794.56), lo que indica una mejor capacidad de ajuste y menor p√©rdida de informaci√≥n. Esto se debe a que las variables continuas permiten capturar variaciones m√°s sutiles en los datos, especialmente en contextos donde la relaci√≥n con la RCP puede ser m√°s compleja que una simple dicotom√≠a. 


# An√°lisis de Supervivencia

En estudios cl√≠nicos oncol√≥gicos, no solo resulta relevante saber si un evento ocurre, sino cu√°ndo ocurre. El an√°lisis de supervivencia responde precisamente a esta necesidad, permitiendo modelar el tiempo hasta la aparici√≥n de un evento de inter√©s, teniendo en cuenta tanto los pacientes que experimentan dicho evento como aquellos que, por diversas razones, no lo hacen durante el seguimiento (pacientes censurados).

Este enfoque aporta una ventaja fundamental respecto a modelos tradicionales como la regresi√≥n log√≠stica, ya que incorpora la dimensi√≥n temporal y es capaz de manejar informaci√≥n incompleta de forma adecuada. En el caso cl√≠nico que nos ocupa, el evento considerado es el fallecimiento, y el objetivo es estimar la probabilidad de supervivencia global (SG) a lo largo del tiempo.

## Concepto de funci√≥n de supervivencia

La funci√≥n de supervivencia, denotada por \\( S(t) \\), representa la probabilidad de que un individuo sobreviva m√°s all√° del tiempo \\( t \\). Se define como:

\[
S(t) = P(T > t)
\]

donde \\( T \\) es una variable aleatoria que representa el tiempo hasta el evento. Esta funci√≥n decrece con el tiempo y su estimaci√≥n pr√°ctica se realiza mediante el m√©todo no param√©trico de **Kaplan-Meier**, que proporciona una curva escalonada reflejando la probabilidad acumulada de supervivencia.


En nuestro estudio, se define como evento de inter√©s el fallecimiento por c√°ncer de mama. Esta informaci√≥n se encuentra codificada en la variable ESTADO_ULTIMO_CONTROL, que recoge el estado vital de cada paciente al momento del √∫ltimo seguimiento. Se considera que ha ocurrido un evento (evento = 1) cuando ESTADO_ULTIMO_CONTROL == "MCE" (muerte por causa de la enfermedad). En todos los dem√°s casos, el paciente se considera censurado (evento = 0), incluyendo aquellas que permanecen vivas (VSE), aquellas fallecidas por otras causas o las que abandonaron el seguimiento antes de observarse un evento.

Adem√°s del estado vital, el an√°lisis de supervivencia requiere conocer el tiempo exacto de seguimiento de cada paciente, que se calcula como la diferencia entre la fecha de diagn√≥stico (FECHA_DIAGNOSTICO) y la fecha del √∫ltimo control cl√≠nico (FECHA_ULTIMO_CONTROL), ambas expresadas en a√±os para mayor claridad en la interpretaci√≥n.

A continuaci√≥n, se presenta el c√≥digo empleado para construir el objeto de an√°lisis y visualizar la curva de supervivencia global para toda la cohorte:



```{r, warning=FALSE, message=FALSE}
#  Limpiar saltos de l√≠nea, retorno de carro y espacios
names(datos) <- gsub("[\\r\\n]", "", names(datos))
names(datos) <- trimws(names(datos))

#  Renombrar la columna de estado si es necesario
names(datos)[names(datos) == "ESTADO_ULTIMO_CONTROL"] <- "ESTADO_ULTIMO_
CONTROL"

# Cargar librer√≠as necesarias
library(survival)
library(survminer)
library(lubridate)
library(dplyr)

# Limpiar nombres de columnas de caracteres especiales
names(datos) <- gsub("[\r\n]", "", names(datos))
names(datos) <- trimws(names(datos))

# Renombrar columna que contiene "ESTADO_ULTIMO"
col_estado <- grep("ESTADO_ULTIMO", names(datos), value = TRUE)
names(datos)[names(datos) == col_estado] <- "ESTADO_ULTIMO_CONTROL"

# Convertir fechas al formato correcto
datos$FECHA_DIAGNOSTICO <- dmy(datos$FECHA_DIAGNOSTICO)
datos$FECHA_ULTIMO_CONTROL <- dmy(datos$FECHA_ULTIMO_CONTROL)

# Calcular tiempo de seguimiento en a√±os
datos$tiempo_SG <- as.numeric(difftime(datos$FECHA_ULTIMO_CONTROL,
                                       datos$FECHA_DIAGNOSTICO,
                                       units = "days")) / 365.25

# Crear variable de evento (1 si falleci√≥, 0 si censurado)
datos$evento_SG <- ifelse(datos$ESTADO_ULTIMO_CONTROL == "MCE", 1, 0)

# Crear objeto de supervivencia
surv_object <- Surv(time = datos$tiempo_SG, event = datos$evento_SG)

# Ajustar modelo Kaplan-Meier
km_fit <- survfit(surv_object ~ 1)

# Graficar curva de supervivencia
ggsurvplot(km_fit,
           data = datos,
           risk.table = TRUE,
           xlab = "Tiempo desde diagn√≥stico (a√±os)",
           ylab = "Probabilidad de supervivencia",
           title = "Curva de supervivencia global (Kaplan-Meier)",
           conf.int = TRUE)


```

En el eje horizontal se representa el tiempo transcurrido desde el diagn√≥stico (en a√±os), mientras que el eje vertical muestra la probabilidad acumulada de supervivencia. Las marcas verticales indican casos censurados, es decir, pacientes que no han experimentado el evento (muerte) al finalizar el seguimiento.

La curva muestra una disminuci√≥n progresiva de la probabilidad de supervivencia a medida que transcurre el tiempo, con una mayor pendiente en los primeros a√±os tras el diagn√≥stico, lo que sugiere una mayor tasa de eventos en esa etapa. Adem√°s, se incluye una banda gris que representa el intervalo de confianza al 95%, reflejando la incertidumbre de la estimaci√≥n.

En la parte inferior del gr√°fico se muestra la tabla de riesgo, que indica el n√∫mero de pacientes a√∫n en seguimiento (no censurados ni fallecidos) en distintos momentos del tiempo.¬øQu√© nos dice esta tabla?

Inicio (0 a√±os): todos los pacientes est√°n en seguimiento ‚Üí 699

A 2.5 a√±os: ya han ocurrido eventos o censura en m√°s de la mitad ‚Üí quedan 299

A 5 a√±os: solo 172 siguen en riesgo

A 10 a√±os: solo 29 personas quedan bajo observaci√≥n

A 15 a√±os: 0 personas ‚Üí el seguimiento se ha completado o censurado para todos


```{r}
# Probabilidad de supervivencia a 2, 5 y 10 a√±os
prob_2 <- summary(km_fit, times = 2)$surv
prob_5 <- summary(km_fit, times = 5)$surv
prob_10 <- summary(km_fit, times = 10)$surv

# Mediana de supervivencia
mediana_supervivencia <- summary(km_fit)$table["median"]

# Mostrar resultados clave
cat("üìå Mediana de supervivencia:", round(mediana_supervivencia, 2), "a√±os\n")
cat("üìà Probabilidad de estar viva a 2 a√±os:", round(prob_2, 3), "\n")
cat("üìà Probabilidad de estar viva a 5 a√±os:", round(prob_5, 3), "\n")
cat("üìà Probabilidad de estar viva a 10 a√±os:", round(prob_10, 3), "\n")
```


```{r warning=FALSE }
# üìÇ Comparaci√≥n entre grupos cl√≠nicos (ej. FENOTIPO_IHQ)
km_grupos <- survfit(surv_object ~ FENOTIPO_IHQ, data = datos)

# Gr√°fico por grupos
ggsurvplot(km_grupos,
           data = datos,
           risk.table = TRUE,
           pval = TRUE,
           conf.int = TRUE,
           xlab = "Tiempo desde diagn√≥stico (a√±os)",
           ylab = "Probabilidad de supervivencia",
           title = "Supervivencia por fenotipo IHQ")

# ‚öñÔ∏è Test de log-rank para diferencias entre grupos
test_logrank <- survdiff(surv_object ~ FENOTIPO_IHQ, data = datos)
print(test_logrank)

# üìÇ Comparaci√≥n entre grupos cl√≠nicos 
km_grupos <- survfit(surv_object ~ GRADO_CAT , data = datos)

# Gr√°fico por grupos
ggsurvplot(km_grupos,
           data = datos,
           risk.table = TRUE,
           pval = TRUE,
           conf.int = TRUE,
           xlab = "Tiempo desde diagn√≥stico (a√±os)",
           ylab = "Probabilidad de supervivencia",
           title = "Supervivencia por GRADO_CAT")

# ‚öñÔ∏è Test de log-rank para diferencias entre grupos
test_logrank <- survdiff(surv_object ~ GRADO_CAT, data = datos)
print(test_logrank)


# üìÇ Comparaci√≥n entre grupos cl√≠nicos 
km_grupos <- survfit(surv_object ~ TIPO_CIRUGIA , data = datos)

# Gr√°fico por grupos
ggsurvplot(km_grupos,
           data = datos,
           risk.table = TRUE,
           pval = TRUE,
           conf.int = TRUE,
           xlab = "Tiempo desde diagn√≥stico (a√±os)",
           ylab = "Probabilidad de supervivencia",
           title = "Supervivencia por TIPO_CIRUGIA")

# ‚öñÔ∏è Test de log-rank para diferencias entre grupos
test_logrank <- survdiff(surv_object ~ TIPO_CIRUGIA, data = datos)
print(test_logrank)



# üìÇ Comparaci√≥n entre grupos cl√≠nicos 
km_grupos <- survfit(surv_object ~ RCP_1 , data = datos)

# Gr√°fico por grupos
ggsurvplot(km_grupos,
           data = datos,
           risk.table = TRUE,
           pval = TRUE,
           conf.int = TRUE,
           xlab = "Tiempo desde diagn√≥stico (a√±os)",
           ylab = "Probabilidad de supervivencia",
           title = "Supervivencia por RCP_1")

# ‚öñÔ∏è Test de log-rank para diferencias entre grupos
test_logrank <- survdiff(surv_object ~ RCP_1, data = datos)
print(test_logrank)


```
Finalmente, los pacientes que lograron respuesta completa patol√≥gica (RCP_1 = "SI") presentan una supervivencia notablemente mayor en comparaci√≥n con aquellos que no la alcanzaron. Tambi√©n se observa que los pacientes sometidos a cirug√≠a conservadora tienen una mayor probabilidad de supervivencia que aquellos que recibieron cirug√≠a radical, lo que puede reflejar un mejor estadio inicial o una mejor respuesta al tratamiento neoadyuvante. Asimismo, los tumores de menor grado histol√≥gico (GRADO_CAT = 1/2) est√°n asociados a una mejor supervivencia que los de alto grado (GRADO_CAT = 3). Por √∫ltimo, el an√°lisis por fenotipo IHQ revela que el subtipo Luminal presenta el mejor pron√≥stico, seguido de Her2, mientras que el triple negativo muestra la supervivencia m√°s baja. Todas estas diferencias fueron estad√≠sticamente significativas (p < 0.05), lo que resalta la importancia de estas variables como factores pron√≥stico clave en el manejo del c√°ncer de mama.

